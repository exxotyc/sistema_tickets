{# templates/tickets/base.html #}
<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Tickets · Coyahue{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    {% block extra_head %}{% endblock %}

    <style>
        :root{ --bg-a:#0ea5e9; --bg-b:#6366f1; --glass:rgba(255,255,255,.78); --glass-border:rgba(255,255,255,.35) }
        html,body{height:100%}
        body{
            background:
            radial-gradient(1200px 900px at 20% -10%, var(--bg-a) 0%, transparent 60%),
            radial-gradient(1000px 800px at 110% 10%, var(--bg-b) 0%, transparent 55%),
            linear-gradient(180deg, #0f172a 0%, #0b1225 100%);
            -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
        }
        .navbar{
            backdrop-filter:saturate(140%) blur(10px);
            background:var(--glass)!important;
            border-bottom:1px solid var(--glass-border)!important;
        }
        .navbar-brand{font-weight:700; letter-spacing:.2px}
        .badge-soft{background:#fff; border:1px solid rgba(2,6,23,.08); color:#0f172a}
        .card{
            border-radius:1rem; border:1px solid rgba(15,23,42,.06);
            background:rgba(255,255,255,.92); backdrop-filter:blur(6px);
            box-shadow:0 18px 40px rgba(2,6,23,.12);
        }
        .btn{border-radius:.75rem; position:relative; overflow:hidden}
        .btn-ripple::after{
            content:""; position:absolute; width:0; height:0; border-radius:50%;
            background:rgba(255,255,255,.5); transform:translate(-50%,-50%);
            left:var(--x,50%); top:var(--y,50%); transition:width .4s ease, height .4s ease;
        }
        .btn-ripple:active::after{width:220px; height:220px}
        .notif-fab{
            position:fixed; right:18px; bottom:18px; z-index:1080;
            border-radius:999px; padding:.65rem .8rem;
            box-shadow:0 10px 24px rgba(2,6,23,.16);
        }
        .notif-badge{ position:absolute; top:-6px; right:-6px; }
    </style>
</head>

<body>

{% if request.user.is_authenticated %}
    <button id="btnNotif" class="btn btn-primary notif-fab btn-ripple">
        <i class="bi bi-bell"></i>
        <span id="notifCount" class="badge text-bg-danger notif-badge d-none">0</span>
    </button>

    <div id="notifPanel" class="card shadow-sm"
         style="position:fixed; right:18px; bottom:74px; width:320px; display:none; z-index:1080;">
        <div class="card-header d-flex justify-content-between">
            <span>Notificaciones</span>
            <button id="notifClose" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <ul id="notifList" class="list-group list-group-flush">
            <li class="list-group-item text-muted">Sin notificaciones.</li>
        </ul>
    </div>
{% endif %}


{% if request.user.is_authenticated %}
<nav class="navbar navbar-expand-md sticky-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2" href="{% url 'dashboard' %}">
            <i class="bi bi-ticket-perforated-fill text-primary"></i>
            <span>Coyahue Tickets</span>
            <span class="badge rounded-pill badge-soft">Coyahue</span>
        </a>

        <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav"></button>
{% endif %}

        <div id="nav" class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2">

                {% if request.user.is_authenticated %}
                    <li class="nav-item"><a class="nav-link" href="{% url 'dashboard' %}">
                        <i class="bi bi-speedometer2 me-1"></i> Dashboard
                    </a></li>

                    {% if is_admin or is_tecnico %}
                    <li class="nav-item"><a class="nav-link" href="{% url 'metrics_page' %}">
                        <i class="bi bi-graph-up me-1"></i> Métricas </a>
                    </li>
                    {% endif %}

                    <li class="nav-item"><a class="nav-link" href="{% url 'ticket_list' %}">
                        <i class="bi bi-list-ul me-1"></i> Listado 
                    </a></li>

                    <li class="nav-item"><a class="nav-link" href="{% url 'faq' %}">
                        <i class="bi bi-question-circle me-1"></i> FAQ
                    </a></li>

                    {% if is_tecnico %}
                      <li class="nav-item"><a class="nav-link" href="{% url 'ticket_list_assigned' %}">Mis Tickets</a></li>
                      <li class="nav-item"><a class="nav-link" href="{% url 'ticket_list_all' %}">Todos los Tickets</a></li>
                    {% endif %}

                    {% if is_admin or is_tecnico %}
                    <li class="nav-item"><a class="nav-link" href="{% url 'reports_page' %}">
                        <i class="bi bi-file-bar-graph me-1"></i> Reportes
                    </a></li>
                    {% endif %}

                    {% if is_admin and maint_sections %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">
                            <i class="bi bi-gear-wide-connected me-1"></i> Mantenedor
                        </a>
                        <ul class="dropdown-menu">
                            {% for s in maint_sections %}
                            <li><a class="dropdown-item" href="{% url 'maint_section' s.code %}">{{ s.title }}</a></li>
                            {% endfor %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'maint_index' %}">Ver todas</a></li>
                        </ul>
                    </li>

                    <li class="nav-item"><a class="nav-link" href="{% url 'sistema_page' %}">
                        <i class="bi bi-hdd-network me-1"></i> Sistema
                    </a></li>
                    {% endif %}

                {% endif %}
            </ul>

            <div class="d-flex gap-2">
                {% if request.user.is_authenticated %}
                    <span class="text-muted small">Hola, {{ request.user.username }}</span>
                    <a class="btn btn-outline-secondary btn-sm btn-ripple" href="{% url 'logout' %}">
                        <i class="bi bi-box-arrow-right me-1"></i>Salir
                    </a>
                {% else %}
                    <a class="btn btn-primary btn-sm btn-ripple" href="{% url 'login' %}">
                        <i class="bi bi-box-arrow-in-right me-1"></i> Iniciar sesión
                    </a>
                {% endif %}
            </div>

        </div>
    </div>
</nav>


<main class="container my-4">
    {% if messages %}
        <div class="messages mb-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
    {% block content %}{% endblock %}
</main>

<footer class="py-4 text-center text-muted">
    <div class="container">© {% now "Y" %} Coyahue</div>
</footer>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("pointerdown",(e)=>{
    const btn=e.target.closest(".btn-ripple");
    if(!btn) return;
    const r=btn.getBoundingClientRect();
    btn.style.setProperty("--x",(e.clientX-r.left)+"px");
    btn.style.setProperty("--y",(e.clientY-r.top)+"px");
});
</script>

{% if request.user.is_authenticated %}
<script>
/* ============================================================================
        JWT + CSRF + SESSION TOKEN
============================================================================ */

function getCookie(name){
    const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : "";
}


/* =====================================================
   REFRESH TOKEN
===================================================== */
async function refreshToken(){
    const refresh = localStorage.getItem("refresh_token");
    if(!refresh) return null;

    const r = await fetch("/api/token/refresh/", {
        method:"POST",
        credentials:"include",
        headers:{
            "Content-Type":"application/json",
            "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ refresh })
    });

    if(!r.ok) return null;

    const data = await r.json();
    localStorage.setItem("access_token", data.access);
    return data.access;
}


/* =====================================================
   GLOBAL FETCH (con JWT)
===================================================== */
async function apiFetch(url, options = {}){
    options.headers = options.headers || {};
    options.credentials = "include";

    const access = localStorage.getItem("access_token");
    if(access){
        options.headers["Authorization"] = "Bearer " + access;
    }

    if(["POST","PUT","PATCH","DELETE"].includes(options.method)){
        options.headers["Content-Type"] = "application/json";
        options.headers["X-CSRFToken"] = getCookie("csrftoken");
    }

    let response = await fetch(url, options);

    if(response.status === 401){
        const newT = await refreshToken();
        if(newT){
            options.headers["Authorization"] = "Bearer " + newT;
            response = await fetch(url, options);
        }
    }
    return response;
}


/* =====================================================
   CREAR TOKEN DESPUÉS DEL LOGIN (SI NO EXISTE)
===================================================== */
(async ()=>{
    const user = "{{ request.user.username }}";
    const stored = localStorage.getItem("username");

    // Si el usuario cambió, borrar todo
    if(stored && stored !== user){
        localStorage.clear();
    }

    // Si no existe token, crearlo
    if(!localStorage.getItem("access_token")){
        const r = await fetch("{% url 'api:token_session' %}", {
            method:"POST",
            credentials:"include",
            headers:{ "X-CSRFToken": getCookie("csrftoken") }
        });

        if(r.ok){
            const data = await r.json();
            localStorage.setItem("access_token", data.access);
            localStorage.setItem("refresh_token", data.refresh);
            localStorage.setItem("username", user);
        }
    }
})();
</script>
{% endif %}

{% block auth_protect %}{% endblock %}
{% block extra_js %}{% endblock %}

</body>
</html>
