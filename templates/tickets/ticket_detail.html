{% extends "tickets/base.html" %}
{% block title %}Ticket · Coyahue{% endblock %}

{% block extra_head %}
<style>
  .glass{
    background:rgba(255,255,255,.92);
    backdrop-filter:blur(6px);
    border:1px solid rgba(15,23,42,.06);
    border-radius:1rem
  }
  .meta dt{color:#6c757d; width:140px}
  .meta dd{margin-bottom:.5rem}
  .attachment{display:flex; align-items:center; gap:.5rem}
</style>
{% endblock %}

{% block content %}
<div
  class="glass p-3 p-md-4"
  id="ticket-root"
  data-ticket-id="{{ ticket_id }}"
  data-admin="{% if is_admin %}1{% else %}0{% endif %}"
>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 id="tTitle" class="h5 m-0 d-flex align-items-center gap-2">
      <i class="bi bi-ticket-perforated"></i> Ticket
    </h1>
    <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary btn-sm btn-ripple" data-hard-nav="1">
      <i class="bi bi-arrow-left"></i> Volver
    </a>
  </div>

  <div class="row g-4">
    <!-- Col principal -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h5 class="mb-2" id="title">—</h5>
          <p id="description" class="text-muted">—</p>
        </div>
      </div>

      <!-- Comentarios -->
      <div class="card mt-3">
        <div class="card-body">
          <h6 class="mb-2"><i class="bi bi-chat-left-text me-1"></i> Comentarios</h6>

          <ul id="comments" class="list-group list-group-flush mb-3"></ul>

          <form id="frmComment" class="d-flex gap-2">
            <input id="commentText" class="form-control" placeholder="Escribe un comentario…" required>
            <button class="btn btn-primary btn-ripple" type="submit"><i class="bi bi-send"></i></button>
          </form>
        </div>
      </div>

      <!-- Adjuntos -->
      <div class="card mt-3">
        <div class="card-body">
          <h6 class="mb-2"><i class="bi bi-paperclip me-1"></i> Adjuntos</h6>
          <ul id="attachments" class="list-group list-group-flush mb-3"></ul>

          <form id="frmAttach" class="d-flex flex-wrap gap-2" enctype="multipart/form-data">
            <input id="file" name="file" type="file" class="form-control"
                   accept=".pdf,.png,.jpg,.jpeg,.webp,.txt,.csv,.xlsx,.docx,.pptx,.log"
                   required>
            <button class="btn btn-outline-primary btn-ripple" type="submit">
              <i class="bi bi-upload"></i> Subir
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Col lateral -->
    <div class="col-lg-4">

      <!-- Panel admin / técnico -->
      <div id="adminPanel" class="card d-none">
        <div class="card-body">
          <h6 class="mb-3"><i class="bi bi-tools me-1"></i> Acciones de administración</h6>

          <div class="mb-3">
            <label class="form-label">Asignar a técnico</label>
            <div class="d-flex gap-2">
              <select id="techSelect" class="form-select">
                <option value="" selected disabled>Cargando…</option>
              </select>
              <button id="btnAssign" class="btn btn-primary btn-ripple"><i class="bi bi-person-check"></i></button>
            </div>
            <div id="assignMsg" class="form-text"></div>
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Estado</label>
              <select id="stateSelect" class="form-select form-select-sm">
                <option value="open">Abierto</option>
                <option value="in_progress">En progreso</option>
                <option value="resolved">Resuelto</option>
                <option value="closed">Cerrado</option>
              </select>
            </div>

            <div class="col-6">
              <label class="form-label">Prioridad</label>
              <select id="prioSelect" class="form-select form-select-sm">
                <option disabled>Cargando…</option>
              </select>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-3">
            <button id="btnSaveMeta" class="btn btn-outline-primary btn-sm btn-ripple">
              <i class="bi bi-save"></i> Guardar
            </button>
            <button id="btnStart" class="btn btn-outline-secondary btn-sm btn-ripple">
              <i class="bi bi-play"></i> En progreso
            </button>
            <button id="btnResolve" class="btn btn-outline-success btn-sm btn-ripple">
              <i class="bi bi-check2-circle"></i> Resolver
            </button>
            <button id="btnClose" class="btn btn-outline-dark btn-sm btn-ripple">
              <i class="bi bi-lock"></i> Cerrar
            </button>
            <button id="btnReopen" class="btn btn-outline-warning btn-sm btn-ripple">
              <i class="bi bi-arrow-counterclockwise"></i> Reabrir
            </button>
          </div>

        </div>
      </div>

      <!-- Panel detalle -->
      <div class="card mt-3">
        <div class="card-body">
          <h6 class="mb-3">Detalle</h6>
          <dl class="row meta">
            <dt class="col-4">ID</dt><dd id="m_id" class="col-8">—</dd>
            <dt class="col-4">Estado</dt><dd id="m_state" class="col-8">—</dd>
            <dt class="col-4">Prioridad</dt><dd id="m_priority" class="col-8">—</dd>
            <dt class="col-4">Categoría</dt><dd id="m_category" class="col-8">—</dd>
            <dt class="col-4">Solicitante</dt><dd id="m_requester" class="col-8">—</dd>
            <dt class="col-4">Asignado a</dt><dd id="m_assigned" class="col-8">—</dd>
            <dt class="col-4">Creado</dt><dd id="m_created" class="col-8">—</dd>
            <dt class="col-4">Actualizado</dt><dd id="m_updated" class="col-8">—</dd>
          </dl>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block auth_protect %}
<script>
(async function ensureAuth(){
  const access = localStorage.getItem("access_token");
  if(!access){ location.href="/"; return; }
  const r = await fetch("/api/stats/", { headers:{ Authorization:"Bearer "+access }});
  if(r.ok) return;
  localStorage.clear(); location.href="/";
})();
</script>
{% endblock %}

{% block extra_js %}
<script>

// =========================
//   ROOT + CONSTANTES
// =========================
const ROOT = document.getElementById("ticket-root");
const TICKET_ID = Number(ROOT.dataset.ticketId);
const SERVER_ADMIN = ROOT.dataset.admin === "1";

//
// API base
//
async function apiFetch(url, opts = {}) {
  const access = localStorage.getItem("access_token");
  const full = url.startsWith("/api") ? url : "/api" + url;

  const r = await fetch(full, {
    ...opts,
    headers: { ...(opts.headers || {}), Authorization: "Bearer " + access }
  });
  return r;
}

function esc(s){
  return String(s || "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}

function fmt(d){ return d ? new Date(d).toLocaleString() : "-"; }

async function getJSON(url){
  const r = await apiFetch(url);
  if(!r.ok) return null;
  return r.json();
}

async function sendJSON(url, method, body){
  const r = await apiFetch(url,{
    method,
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  if(!r.ok){
    let msg="Error";
    try{ const j = await r.json(); msg = j.detail || j.error || JSON.stringify(j); }catch{}
    return { ok:false, error:msg };
  }
  const data = await r.json().catch(()=>null);
  return { ok:true, data };
}

//
// Cargar prioridades (FK)
//
async function loadPriorities(){
  const sel = document.getElementById("prioSelect");
  sel.innerHTML = '<option disabled>Cargando…</option>';

  const r = await apiFetch("/api/priorities/");
  if(!r.ok){ sel.innerHTML='<option disabled>Error</option>'; return; }

  const data = await r.json();
  const list = Array.isArray(data) ? data : data.results || data;

  sel.innerHTML = "";
  list.forEach(p=>{
    const o=document.createElement("option");
    o.value = p.id;
    o.textContent = `${p.name} (${p.code})`;
    sel.appendChild(o);
  });
}

//
// Cargar ticket
//
async function loadTicket(){
  const data = await getJSON(`/api/tickets/${TICKET_ID}/`);
  if(!data){ alert("No se pudo cargar el ticket."); return; }

  document.getElementById("tTitle").innerHTML = `<i class="bi bi-ticket-perforated"></i> Ticket #${data.id}`;
  document.getElementById("title").textContent = data.title;
  document.getElementById("description").textContent = data.description;

  document.getElementById("m_id").textContent = data.id;
  document.getElementById("m_state").textContent = data.state;
  document.getElementById("m_priority").textContent = data.priority_name || "-";
  document.getElementById("m_category").textContent = data.category_name || "-";
  document.getElementById("m_requester").textContent = data.requester_username || "-";
  document.getElementById("m_assigned").textContent = data.assigned_to_username || "-";
  document.getElementById("m_created").textContent = fmt(data.created_at);
  document.getElementById("m_updated").textContent = fmt(data.updated_at);

  const stateSel = document.getElementById("stateSelect");
  const prioSel = document.getElementById("prioSelect");

  if(stateSel) stateSel.value = data.state;
  if(prioSel && data.priority){
    prioSel.value = data.priority; // ID de prioridad
  }
}

//
// COMMENTS
//
async function loadComments(){
  const r = await apiFetch(`/api/comments/?ticket=${TICKET_ID}&ordering=created_at`);
  if(!r.ok) return;
  const data = await r.json();
  const list = data.results || data;

  const ul=document.getElementById("comments");
  ul.innerHTML = list.length ? "" : '<li class="list-group-item text-muted">Sin comentarios</li>';

  list.forEach(c=>{
    const li=document.createElement("li");
    li.className="list-group-item";
    li.innerHTML = `
      <div class="d-flex justify-content-between">
        <strong>${esc(c.user_username)}</strong><small>${fmt(c.created_at)}</small>
      </div>
      <div>${esc(c.content)}</div>
    `;
    ul.appendChild(li);
  });
}

//
// ADJUNTOS
//
async function loadAttachments(){
  const r = await apiFetch(`/api/attachments/?ticket=${TICKET_ID}`);
  if(!r.ok) return;

  const data = await r.json();
  const list = data.results || data;

  const ul=document.getElementById("attachments");
  ul.innerHTML = list.length ? "" : '<li class="list-group-item text-muted">Sin adjuntos</li>';

  list.forEach(a=>{
    ul.innerHTML += `
      <li class="list-group-item">
        <div class="attachment">
          <i class="bi bi-paperclip"></i>
          <a href="${esc(a.file)}" target="_blank">${esc(a.filename)}</a>
          <small class="text-muted ms-auto">${fmt(a.created_at)}</small>
        </div>
      </li>`;
  });
}

//
// Cargar técnicos
//
async function loadUsers(){
  const sel=document.getElementById("techSelect");
  const r = await apiFetch("/api/users/");
  if(!r.ok){ sel.innerHTML='<option disabled>Error</option>'; return; }

  const data=await r.json();
  const list = Array.isArray(data) ? data : data.results || [];

  const filtered = list.filter(u => u.roles && (u.roles.includes("admin") || u.roles.includes("tecnico")));

  sel.innerHTML='<option value="" disabled selected>Seleccionar técnico</option>';
  filtered.forEach(u=>{
    const o=document.createElement("option");
    o.value=u.id;
    o.textContent = `${u.username} (${u.roles.join(",")})`;
    sel.appendChild(o);
  });
}

//
// Guardar estado + prioridad
//
async function saveMeta(state, priority){
  const res = await sendJSON(`/api/tickets/${TICKET_ID}/`, "PATCH", { state, priority });
  if(!res.ok){ alert(res.error); return; }
  await loadTicket();
}

//
// Crear comentario
//
document.getElementById("frmComment").onsubmit = async e=>{
  e.preventDefault();
  const txt=document.getElementById("commentText");
  const val=txt.value.trim();
  if(!val) return;

  const res=await sendJSON("/api/comments/","POST",{ ticket:TICKET_ID, content:val });
  if(!res.ok){ alert(res.error); return; }

  txt.value=""; loadComments();
};

//
// Adjuntos
//
document.getElementById("frmAttach").onsubmit = async e=>{
  e.preventDefault();
  const sel=document.getElementById("file");
  const file=sel.files[0];
  if(!file) return;
  const fd=new FormData();
  fd.append("ticket",TICKET_ID);
  fd.append("file",file);
  const r = await apiFetch("/api/attachments/",{method:"POST",body:fd});
  if(!r.ok){ alert("Error al subir archivo"); return; }
  sel.value="";
  loadAttachments();
};

//
// ASIGNAR TÉCNICO
//
document.getElementById("btnAssign").onclick = async () => {
    const sel = document.getElementById("techSelect");
    const userId = sel.value;
    const msg = document.getElementById("assignMsg");

    if (!userId) {
        msg.textContent = "Debes seleccionar un técnico.";
        msg.className = "form-text text-danger";
        return;
    }

    const res = await sendJSON(`/api/tickets/${TICKET_ID}/assign/`, "POST", {
        user_id: Number(userId)
    });

    if (!res.ok) {
        msg.textContent = res.error;
        msg.className = "form-text text-danger";
        return;
    }

    msg.textContent = `Asignado a ${res.data.assigned_to}`;
    msg.className = "form-text text-success";

    await loadTicket();
};

//
// INIT
//
(async function init(){
  if(!TICKET_ID){
    console.error("No se encontró ticket_id en el template");
    return;
  }

  await loadPriorities();
  await loadTicket();
  await loadComments();
  await loadAttachments();

  const r = await apiFetch("/api/stats/");
  const data = r.ok ? await r.json() : {};
  const roles = data.user?.roles || [];

  const adminP=document.getElementById("adminPanel");

  if(roles.includes("admin") || roles.includes("tecnico") || SERVER_ADMIN){
    adminP.classList.remove("d-none");
    await loadUsers();
  }

  document.getElementById("btnSaveMeta").onclick = ()=>saveMeta(
    document.getElementById("stateSelect").value,
    document.getElementById("prioSelect").value
  );
  document.getElementById("btnStart").onclick = ()=>saveMeta("in_progress",document.getElementById("prioSelect").value);
  document.getElementById("btnResolve").onclick = ()=>saveMeta("resolved",document.getElementById("prioSelect").value);
  document.getElementById("btnClose").onclick = ()=>saveMeta("closed",document.getElementById("prioSelect").value);
  document.getElementById("btnReopen").onclick = ()=>saveMeta("open",document.getElementById("prioSelect").value);
})();
</script>
{% endblock %}
