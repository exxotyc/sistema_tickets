{% extends "tickets/base.html" %}
{% block title %}Ticket ¬∑ Coyahue{% endblock %}

{% block extra_head %}
<style>
  /* --------- LAYOUT COMPACTO --------- */
  .glass{
    background:rgba(255,255,255,.94);
    backdrop-filter:blur(5px);
    border:1px solid rgba(15,23,42,.06);
    border-radius:.9rem;
  }

  .card { border-radius:.8rem; }
  .card-body { padding:1.1rem 1.2rem; }

  /* Tabs */
  .ticket-tabs{
    border-bottom:1px solid rgba(0,0,0,.08);
    margin-bottom:.5rem;
    display:flex;
    gap:.2rem;
  }
  .ticket-tab-btn{
    border:none;
    background:transparent;
    padding:.35rem .65rem;
    border-radius:.55rem .55rem 0 0;
    font-size:.85rem;
    color:#6c757d;
    cursor:pointer;
  }
  .ticket-tab-btn.active{
    color:#0d6efd;
    background:#fff;
    border:1px solid rgba(0,0,0,.12);
    border-bottom-color:#fff;
    border-bottom-width:0;
  }

  .ticket-tab-pane{ display:none; }
  .ticket-tab-pane.active{ display:block; }

  /* Comentarios */
  .comments-wrapper{ height:340px; display:flex; flex-direction:column; }
  .comments-scroll{
    flex:1;
    overflow-y:auto;
    padding-right:.25rem;
  }
  .comment-item{
    padding:.35rem .55rem;
    font-size:.87rem;
    border-radius:.45rem;
    margin-bottom:.35rem;
    background:#f8f9fa;
    border:1px solid rgba(0,0,0,.05);
  }
  .comment-mine{
    background:#e7f1ff;
    border-color:#b6d4fe;
  }
  .comment-header{ font-size:.75rem; margin-bottom:.1rem; }

  /* Adjuntos */
  .attachments-scroll{
    max-height:220px;
    overflow-y:auto;
  }

  /* Panel derecho compacto */
  #adminPanel .card-body,
  .card .card-body{
    padding:1rem .9rem;
  }
  dt{ font-size:.85rem; }
  dd{ font-size:.9rem; }

  /* Botones peque√±os */
  .btn-sm { padding:.25rem .5rem; font-size:.8rem; }
</style>
{% endblock %}

{% block content %}
<div class="glass p-3 p-md-4" id="ticket-root"
     data-ticket-id="{{ ticket_id }}"
     data-admin="{% if is_admin %}1{% else %}0{% endif %}">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h1 id="tTitle" class="h5 m-0">
      <i class="bi bi-ticket-perforated"></i> Ticket
    </h1>

    <div class="d-flex gap-2">
      {% if request.user.id == ticket.requester.id %}
      <a href="{% url 'ticket_edit' ticket.id %}" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-pencil-square"></i> Editar ticket
      </a>
      {% endif %}

      <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary btn-sm" data-hard-nav="1">
        <i class="bi bi-arrow-left"></i> Volver
      </a>
    </div>
  </div>

  <div class="row g-3">
    <!-- =========================
         COLUMNA PRINCIPAL
    ============================== -->
    <div class="col-lg-8">

      <!-- Tabs -->
      <div class="ticket-tabs">
        <button class="ticket-tab-btn active" data-tab-target="details">
          <i class="bi bi-info-circle"></i> Detalles
        </button>
        <button class="ticket-tab-btn" data-tab-target="comments">
          <i class="bi bi-chat-left-text"></i> Comentarios
        </button>
        <button class="ticket-tab-btn" data-tab-target="attachments">
          <i class="bi bi-paperclip"></i> Adjuntos
        </button>
        <button class="ticket-tab-btn" data-tab-target="history">
          <i class="bi bi-clock-history"></i> Historial
        </button>
      </div>

      <div class="ticket-tab-content">

<!-- =========================
     TAB: DETALLES
============================== -->
<div class="ticket-tab-pane active" data-tab-pane="details">
  <div class="card">
    <div class="card-body">

      <!-- Encabezado -->
      <div class="d-flex justify-content-between gap-2 mb-2">
        <!-- Vista normal -->
        <h5 class="mb-0" id="titleView">‚Äî</h5>

        <!-- Campo editable (oculto por defecto) -->
        <input id="editTitle" class="form-control form-control-sm d-none" />

        <div class="d-flex gap-1">
          <span id="badgeState" class="badge text-bg-secondary">‚Äî</span>
          <span id="badgePriority" class="badge text-bg-light border">‚Äî</span>
        </div>
      </div>

      <!-- Descripci√≥n (vista normal) -->
      <p id="descriptionView" class="text-muted small mb-2">‚Äî</p>

      <!-- Descripci√≥n editable -->
      <textarea id="editDescription" class="form-control form-control-sm d-none mb-2" rows="3"></textarea>

      <!-- Botones -->
      <div class="d-flex gap-2 mt-2">
        <!-- Editar (solo visible seg√∫n permisos JS) -->
        <button id="btnEditTicket" class="btn btn-outline-primary btn-sm d-none">
          <i class="bi bi-pencil"></i> Editar ticket
        </button>

        <!-- Guardar cambios -->
        <button id="btnSaveTicket" class="btn btn-primary btn-sm d-none">
          <i class="bi bi-save"></i> Guardar cambios
        </button>
      </div>

    </div>
  </div>
</div>


        <!-- =========================
             TAB: COMENTARIOS
        ============================== -->
        <div class="ticket-tab-pane" data-tab-pane="comments">
          <div class="card">
            <div class="card-body comments-wrapper">
              <h6 class="mb-1"><i class="bi bi-chat-left-text me-1"></i> Conversaci√≥n</h6>
              <div id="commentsList" class="comments-scroll"></div>

              <form id="frmComment" class="d-flex gap-2 mt-2 pt-1">
                <input id="commentText" class="form-control form-control-sm"
                       placeholder="Escribe un comentario‚Ä¶" required>
                <button class="btn btn-primary btn-sm" type="submit">
                  <i class="bi bi-send"></i>
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- =========================
             TAB: ADJUNTOS
        ============================== -->
        <div class="ticket-tab-pane" data-tab-pane="attachments">
          <div class="card">
            <div class="card-body">

              <h6 class="mb-2"><i class="bi bi-paperclip me-1"></i> Archivos</h6>

              <div id="attachments" class="list-group attachments-scroll mb-2"></div>

              <form id="frmAttach" class="d-flex flex-wrap gap-2" enctype="multipart/form-data">
                <input id="file" name="file" type="file"
                       class="form-control form-control-sm"
                       accept=".pdf,.png,.jpg,.jpeg,.webp,.txt,.csv,.xlsx,.docx,.pptx,.log" required>
                <button class="btn btn-outline-primary btn-sm" type="submit">
                  <i class="bi bi-upload"></i> Subir
                </button>
              </form>

            </div>
          </div>
        </div>

        <!-- =========================
             TAB: HISTORIAL
        ============================== -->
        <div class="ticket-tab-pane" data-tab-pane="history">
          <div class="card">
            <div class="card-body">
              <h6 class="mb-2"><i class="bi bi-clock-history me-1"></i> Historial</h6>
              <div id="historyList" class="small" style="max-height:300px; overflow-y:auto;"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- =========================
         COLUMNA DERECHA (META)
    ============================== -->
    <div class="col-lg-4">

      <!-- METADATOS -->
      <div class="card mb-2">
        <div class="card-body">
          <h6 class="mb-2">Detalle</h6>

          <dl class="row meta small">
            <dt class="col-4">ID</dt> <dd class="col-8" id="m_id">‚Äî</dd>
            <dt class="col-4">Estado</dt> <dd class="col-8" id="m_state">‚Äî</dd>
            <dt class="col-4">Prioridad</dt> <dd class="col-8" id="m_priority">‚Äî</dd>
            <dt class="col-4">Categor√≠a</dt> <dd class="col-8" id="m_category">‚Äî</dd>
            <dt class="col-4">Solicitante</dt> <dd class="col-8" id="m_requester">‚Äî</dd>
            <dt class="col-4">Asignado</dt> <dd class="col-8" id="m_assigned">‚Äî</dd>
            <dt class="col-4">√Årea Solicitante</dt> <dd class="col-8" id="m_requester_area">‚Äî</dd>
            <dt class="col-4">√Årea T√©cnico</dt> <dd class="col-8" id="m_assigned_area">‚Äî</dd>
            <dt class="col-4">Creado</dt> <dd class="col-8" id="m_created">‚Äî</dd>
            <dt class="col-4">Actualizado</dt> <dd class="col-8" id="m_updated">‚Äî</dd>
          </dl>
        </div>
      </div>

      <!-- PANEL DE ACCIONES (Solo t√©cnico/admin) -->
      <div id="adminPanel" class="card d-none">
        <div class="card-body">
          <h6 class="mb-2">
            <i class="bi bi-tools me-1"></i> Acciones
          </h6>

          <div id="techContextMsg" class="small text-muted mb-2"></div>

                    <!-- ASIGNACI√ìN -->
          <div id="assignSection" class="mb-2">
              <label class="form-label small">Asignar a</label>
              <div class="d-flex gap-2">
                  <select id="techSelect" class="form-select form-select-sm">
                      <option disabled>Cargando‚Ä¶</option>
                  </select>
                  <button id="btnAssign" class="btn btn-primary btn-sm"><i class="bi bi-person-check"></i></button>
              </div>
              <div id="assignMsg" class="form-text small"></div>

              <!-- üî• NUEVO -->
              <div id="techLockMsg" class="form-text text-muted small d-none"></div>
          </div>

          <!-- TOMAR TICKET -->
          <button id="btnTakeTicket" class="btn btn-outline-primary btn-sm w-100 mb-2 d-none">
            <i class="bi bi-hand-index-thumb"></i> Tomar ticket
          </button>

          <!-- EDITAR META: ESTADO / PRIORIDAD / CATEGOR√çA -->
          <div class="row g-1">

            <!-- Estado -->
            <div class="col-4">
              <label class="form-label small">Estado</label>
              <select id="stateSelect" class="form-select form-select-sm">
                <option value="open">Abierto</option>
                <option value="in_progress">En progreso</option>
                <option value="resolved">Resuelto</option>
                <option value="closed">Cerrado</option>
              </select>
            </div>

            <!-- Prioridad -->
            <div class="col-4">
              <label class="form-label small">Prioridad</label>
              <select id="prioSelect" class="form-select form-select-sm"></select>
            </div>

            <!-- Categor√≠a (nuevo) -->
            <div class="col-4">
              <label class="form-label small">Categor√≠a</label>
              <select id="categorySelect" class="form-select form-select-sm">
                <option value="">‚Äî</option>
                {% for c in categories %}
                <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>

          </div>

          <!-- Botones de acci√≥n -->
          <div class="d-flex flex-wrap gap-1 mt-2">
            <button id="btnSaveMeta" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-save"></i>
            </button>
            <button id="btnStart" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-play"></i>
            </button>
            <button id="btnResolve" class="btn btn-outline-success btn-sm">
              <i class="bi bi-check2-circle"></i>
            </button>
            <button id="btnClose" class="btn btn-outline-dark btn-sm">
              <i class="bi bi-lock"></i>
            </button>
            <button id="btnReopen" class="btn btn-outline-warning btn-sm">
              <i class="bi bi-arrow-counterclockwise"></i>
            </button>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

{% endblock %}

{% block auth_protect %}
<script>
(async function ensureAuth(){
  const access = localStorage.getItem("access_token");
  if(!access){ location.href="/"; return; }
  const r = await fetch("/api/stats/", { headers:{ Authorization:"Bearer "+access }});
  if(r.ok) return;
  localStorage.clear(); location.href="/";
})();
</script>
{% endblock %}

{% block extra_js %}
<script>
// =====================================================
//   ROOT + CONSTANTES
// =====================================================
const ROOT = document.getElementById("ticket-root");
const TICKET_ID = Number(ROOT.dataset.ticketId);
const SERVER_ADMIN = ROOT.dataset.admin === "1";

let CURRENT_USER = null;
let CURRENT_ROLES = [];
let CURRENT_TICKET = null;

function showToast(message, type="error") {
    const container = document.getElementById("toastContainer");
    if (!container) return;

    const toast = document.createElement("div");
    toast.className = "toast align-items-center text-bg-" +
        (type === "success" ? "success" : "danger") +
        " border-0 show";
    toast.role = "alert";
    toast.ariaLive = "assertive";
    toast.ariaAtomic = "true";

    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${esc(message)}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;

    container.appendChild(toast);

    // Auto remover en 4s
    setTimeout(() => toast.remove(), 4000);
}

// =====================================================
//   HELPERS
// =====================================================

// Usa SIEMPRE el cliente API universal del base.html
// Maneja: CSRF, JWT, Refresh autom√°tico, JSON, FormData
async function api(url, opts = {}) {
  const headers = opts.headers || {};
  const access = localStorage.getItem("access_token");

  // Autenticaci√≥n
  if (access) headers["Authorization"] = "Bearer " + access;

  // CSRF s√≥lo si es JSON y m√©todo escrito
  const isWrite = ["POST","PUT","PATCH","DELETE"].includes((opts.method || "").toUpperCase());
  const isForm = opts.body instanceof FormData;

  if (isWrite) {
    if (!isForm) {
        headers["Content-Type"] = "application/json";
    }
    headers["X-CSRFToken"] = getCookie("csrftoken");
}

  const finalOpts = { ...opts, headers };

  let r = await fetch(url, finalOpts);

  // Si expira ‚Üí refrescar token
  if (r.status === 401) {
    const newT = await refreshToken();
    if (newT) {
      finalOpts.headers["Authorization"] = "Bearer " + newT;
      r = await fetch(url, finalOpts);
    }
  }

  return r;
}

// Obtener cookie CSRF
function getCookie(name){
    const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : "";
}

// refreshToken() id√©ntico al base.html
async function refreshToken(){
    const refresh = localStorage.getItem("refresh_token");
    if(!refresh) return null;

    const r = await fetch("/api/token/refresh/", {
        method:"POST",
        credentials:"include",
        headers:{
            "Content-Type":"application/json",
            "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ refresh })
    });

    if(!r.ok) return null;
    const data = await r.json();
    localStorage.setItem("access_token", data.access);
    return data.access;
}

// Utilidades
function esc(s){
  return String(s || "").replace(/[&<>"']/g, m => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    "\"":"&quot;",
    "'": "&#39;"
  }[m]));
}

function fmt(d){
  return d ? new Date(d).toLocaleString() : "-";
}

async function getJSON(url){
  const r = await api(url);
  if(!r.ok) return null;
  return r.json();
}

async function sendJSON(url, method, body){
  const r = await api(url,{
    method,
    body: JSON.stringify(body)
  });

  if(!r.ok){
    let msg="Error";
    try{ 
      const j = await r.json(); 
      msg = j.detail || j.error || JSON.stringify(j);
    }catch{}
    return { ok:false, error:msg };
  }

  const data = await r.json().catch(()=>null);
  return { ok:true, data };
}

// =====================================================
//   PRIORIDADES
// =====================================================
async function loadPriorities(){
  const sel = document.getElementById("prioSelect");
  sel.innerHTML = '<option disabled>Cargando‚Ä¶</option>';

  const r = await api("/api/priorities/");
  if(!r.ok){ sel.innerHTML='<option disabled>Error</option>'; return; }

  const data = await r.json();
  const list = Array.isArray(data) ? data : data.results || data;

  sel.innerHTML = "";
  list.forEach(p=>{
    const o=document.createElement("option");
    o.value = p.id;
    o.textContent = `${p.name} (${p.code})`;
    sel.appendChild(o);
  });
}

// =====================================================
//   TICKET
// =====================================================
function renderStateBadge(state){
  const el = document.getElementById("badgeState");
  if(!el) return;
  let text = state || "‚Äî";
  let cls = "badge badge-pill text-bg-secondary";

  if(state === "open"){ text="Abierto"; cls="badge badge-pill text-bg-danger"; }
  else if(state === "in_progress"){ text="En progreso"; cls="badge badge-pill text-bg-warning"; }
  else if(state === "resolved"){ text="Resuelto"; cls="badge badge-pill text-bg-primary"; }
  else if(state === "closed"){ text="Cerrado"; cls="badge badge-pill text-bg-success"; }

  el.className = cls;
  el.textContent = text;
}

function renderPriorityBadge(name){
  const el = document.getElementById("badgePriority");
  if(!el) return;

  if(!name){
    el.textContent="Sin prioridad";
    el.className="badge badge-pill text-bg-light border";
    return;
  }

  let cls="badge badge-pill text-bg-light border";
  const n = name.toLowerCase();

  if(n.includes("crit") || n.includes("alta")) cls="badge badge-pill text-bg-danger";
  else if(n.includes("med")) cls="badge badge-pill text-bg-warning";
  else if(n.includes("baj") || n.includes("low")) cls="badge badge-pill text-bg-success";

  el.className = cls;
  el.textContent = name;
}

async function loadTicket(){
  const data = await getJSON(`/api/tickets/${TICKET_ID}/`);
  if(!data){ alert("No se pudo cargar el ticket."); return; }

  CURRENT_TICKET = data;

  document.getElementById("tTitle").innerHTML = `<i class="bi bi-ticket-perforated"></i> Ticket #${data.id}`;
  document.getElementById("titleView").textContent = data.title;
  document.getElementById("descriptionView").textContent = data.description;


  document.getElementById("m_id").textContent = data.id;
  document.getElementById("m_state").textContent = data.state_display || data.state;
  document.getElementById("m_priority").textContent = data.priority_name || "-";
  document.getElementById("m_category").textContent = data.category_name || "-";
  document.getElementById("m_requester").textContent = data.requester_username || "-";
  document.getElementById("m_requester_area").textContent = data.requester_area_name || "-";
  document.getElementById("m_assigned_area").textContent = data.assigned_to_area_name || "-";
  document.getElementById("m_assigned").textContent = data.assigned_to_username || "-";
  document.getElementById("m_created").textContent = fmt(data.created_at);
  document.getElementById("m_updated").textContent = fmt(data.updated_at);

  renderStateBadge(data.state);
  renderPriorityBadge(data.priority_name || "");

  // === FIX CATEGOR√çA ===
  const catSel = document.getElementById("categorySelect");

  if (catSel) {
      if (data.category) {
          const opt = catSel.querySelector(`option[value="${data.category}"]`);
          if (opt) catSel.value = data.category;
          else catSel.value = "";
      } else {
          catSel.value = "";
      }
  }

  const stateSel=document.getElementById("stateSelect");
  const prioSel=document.getElementById("prioSelect");

  if(stateSel) stateSel.value = data.state;
  if(prioSel && data.priority) prioSel.value = data.priority;

  applyPermissionUI();
}


// =====================================================
//   COMENTARIOS ‚Äî FIX DEFINITIVO
// =====================================================

async function loadComments(){
  const wrap=document.getElementById("commentsList");
  wrap.innerHTML='<div class="text-muted small">Cargando comentarios‚Ä¶</div>';

  const r = await api(`/api/comments/?ticket=${TICKET_ID}&ordering=created_at`);
  if(!r.ok){
    wrap.innerHTML='<div class="text-danger small">Error al cargar comentarios.</div>';
    return;
  }

  const data = await r.json();
  const list = data.results || data;

  if(!list.length){
    wrap.innerHTML='<div class="text-muted small">Sin comentarios a√∫n.</div>';
    return;
  }

  wrap.innerHTML="";
  const myId = CURRENT_USER ? CURRENT_USER.id : null;

  list.forEach(c=>{
    const div=document.createElement("div");
    div.className="comment-item"+(c.user===myId ? " comment-mine": "");
    div.innerHTML=`
      <div class="comment-header">
        <span>${esc(c.user_username||"Usuario")}</span>
        <small>${fmt(c.created_at)}</small>
      </div>
      <div>${esc(c.content||"")}</div>
    `;
    wrap.appendChild(div);
  });

  wrap.scrollTop=wrap.scrollHeight;
}

document.addEventListener("DOMContentLoaded",()=>{
  const form = document.getElementById("frmComment");
  if(!form) return;

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    
    const input = document.getElementById("commentText");
    const text = input.value.trim();
    if(!text) return;

    // üî• FIX: enviar JSON correcto con CSRF correcto
    const res = await api("/api/comments/", {
      method: "POST",
      body: JSON.stringify({
        ticket: TICKET_ID,
        content: text
      })
    });

    if(!res.ok){
      try {
        const err = await res.json();
        alert("Error: " + (err.detail || err.error || JSON.stringify(err)));
      } catch(_) {
        alert("No se pudo enviar el comentario");
      }
      return;
    }

    input.value = "";
    loadComments();
  });
});


// =====================================================
//   ADJUNTOS (SUBIDA + LISTADO, SIN RECARGAR PESTA√ëA)
// =====================================================
async function loadAttachments(){
  const cont = document.getElementById("attachments");
  if (!cont) return;

  cont.innerHTML = '<div class="list-group-item small">Cargando‚Ä¶</div>';

  const r = await api(`/api/attachments/?ticket=${TICKET_ID}`);
  if (!r.ok){
    cont.innerHTML =
      '<div class="list-group-item text-danger">Error cargando adjuntos.</div>';
    return;
  }

  const data = await r.json();
  const list = data.results || data;

  if (!list.length){
    cont.innerHTML =
      '<div class="list-group-item small text-muted">Sin adjuntos.</div>';
    return;
  }

  cont.innerHTML = "";
  list.forEach(a => {
    const li = document.createElement("a");
    li.href = a.file;
    li.target = "_blank";
    li.className =
      "list-group-item list-group-item-action d-flex align-items-center gap-2";
    li.innerHTML = `
      <i class="bi bi-paperclip"></i>
      <span>${esc(a.filename)}</span>
      <small class="text-muted ms-auto">${fmt(a.created_at)}</small>
    `;
    cont.appendChild(li);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  const frm = document.getElementById("frmAttach");
  if (!frm) return;

  frm.addEventListener("submit", async (e) => {
    // üö´ BLOQUEAR SUBMIT NATIVO SIEMPRE
    e.preventDefault();
    e.stopPropagation();

    const fileInput = document.getElementById("file");
    const file = fileInput?.files?.[0];

    if (!file) {
      // nada que subir, no hacemos nada pero tampoco recargamos
      return false;
    }

    const fd = new FormData();
    fd.append("ticket", TICKET_ID);
    fd.append("file", file);

    try {
      const r = await api("/api/attachments/", {
        method: "POST",
        body: fd
      });

if (!r.ok) {
    let msg = "Error al subir archivo";

    try {
        const err = await r.json();
        if (err.file) {
            msg = Array.isArray(err.file) ? err.file.join(" ") : err.file;
        } else if (err.detail || err.error) {
            msg = err.detail || err.error;
        } else {
            msg = JSON.stringify(err);
        }
    } catch (_) {}

    showToast(msg, "error");
    return false;
}

        showToast("Archivo subido correctamente", "success");

      // ‚úÖ OK: limpiar input y recargar lista
      fileInput.value = "";
      await loadAttachments();

    } catch (err) {
      console.error("UPLOAD ERROR:", err);
      alert("‚ùå Error inesperado al subir el archivo.");
      return false;
    }

    // Por si acaso, doble seguro para bloquear cualquier submit nativo
    return false;
  });
});

// =====================================================
//   HISTORIAL
// =====================================================
async function loadHistory(){
  const cont=document.getElementById("historyList");
  cont.innerHTML='<div class="text-muted small">Cargando‚Ä¶</div>';

  const r = await api(`/api/logs/?ticket=${TICKET_ID}&ordering=created_at`);
  if(!r.ok){
    cont.innerHTML='<div class="text-danger small">Error al cargar historial.</div>';
    return;
  }

  const data=await r.json();
  const list=data.results || data;

  if(!list.length){
    cont.innerHTML='<div class="text-muted small">Sin historial.</div>';
    return;
  }

  cont.innerHTML="";
  list.forEach(l=>{
    const row=document.createElement("div");
    row.className="border-bottom py-1";
    row.innerHTML=`
      <div class="d-flex justify-content-between">
        <span><strong>${esc(l.user_username||"Sistema")}</strong> ¬∑ ${esc(l.action)}</span>
        <small class="text-muted">${fmt(l.created_at)}</small>
      </div>
    `;
    cont.appendChild(row);
  });
}

// =====================================================
//   LISTA DE T√âCNICOS
// =====================================================
async function loadUsers(){
  const sel=document.getElementById("techSelect");
  if(!sel) return;

  const r = await api("/api/users/");
  if(!r.ok){ sel.innerHTML='<option>Error</option>'; return; }

  const data=await r.json();
  const list=data.results || data;

  const filtered=list.filter(u =>
    u.roles && (u.roles.includes("admin") || u.roles.includes("tecnico"))
  );

  sel.innerHTML='<option disabled selected>Seleccionar t√©cnico</option>';
  filtered.forEach(u=>{
    const o=document.createElement("option");
    o.value=u.id;
    o.textContent=`${u.username} (${u.roles.join(",")})`;
    sel.appendChild(o);
  });
}

// =====================================================
//   META (estado / prioridad)
// =====================================================
async function saveMeta(state, priority) {

    const category = document.getElementById("categorySelect")
        ? document.getElementById("categorySelect").value
        : null;

    const payload = {
        state,
        priority,
        category
    };

    const r = await api(`/api/tickets/${TICKET_ID}/`, {
        method: "PATCH",
        body: JSON.stringify(payload)
    });

    if (!r.ok) {
        showToast("Error al guardar cambios", "error");
        return;
    }

    const data = await r.json();

    // ===========================
    //   ACTUALIZACI√ìN EN PANTALLA
    // ===========================

    // Meta lateral
    document.getElementById("m_state").textContent = data.state_display;
    document.getElementById("m_priority").textContent = data.priority_name;
    document.getElementById("m_category").textContent = data.category_name;

    // Badges superiores
    renderStateBadge(data.state);
    renderPriorityBadge(data.priority_name);

    // Actualizar datos globales
    CURRENT_TICKET.state = data.state;
    CURRENT_TICKET.priority_name = data.priority_name;
    CURRENT_TICKET.category_name = data.category_name;

    showToast("Cambios guardados correctamente", "success");
}

// =====================================================
//   ASIGNACI√ìN
// =====================================================
async function assignTicketTo(userId){
  const msg=document.getElementById("assignMsg");
  if(!userId){
    msg.textContent="Debes seleccionar un t√©cnico.";
    msg.className="form-text text-danger";
    return;
  }

  const res = await sendJSON(`/api/tickets/${TICKET_ID}/assign/`,"POST",{ user_id:Number(userId) });
  if(!res.ok){
    msg.textContent=res.error;
    msg.className="form-text text-danger";
    return;
  }

  msg.textContent=`Asignado a ${res.data.assigned_to}`;
  msg.className="form-text text-success";

  await loadTicket();
  await loadHistory();
}

document.addEventListener("DOMContentLoaded",()=>{
  const btn=document.getElementById("btnAssign");
  if(btn){
    btn.onclick=()=>{
      const sel=document.getElementById("techSelect");
      assignTicketTo(sel.value);
    };
  }
});

document.addEventListener("DOMContentLoaded",()=>{
  const btn=document.getElementById("btnTakeTicket");
  if(btn){
    btn.onclick=async ()=>{
      if(!CURRENT_USER) return;
      await assignTicketTo(CURRENT_USER.id);
    };
  }
});

// =====================================================
//   PERMISOS UI
// =====================================================
function applyPermissionUI() {

    const adminP = document.getElementById("adminPanel");
    const techMsg = document.getElementById("techContextMsg");
    const assignSection = document.getElementById("assignSection");
    const btnTake = document.getElementById("btnTakeTicket");

    const techLockMsg = document.getElementById("techLockMsg");   // mensaje NUEVO
    const assignMsg = document.getElementById("assignMsg");       // mensaje de API

    const frmComment = document.getElementById("frmComment");
    const frmAttach = document.getElementById("frmAttach");

    // Helpers internos
    function disableForms(){
        if(frmComment){
            frmComment.style.display="none";
            frmComment.querySelector("input").disabled=true;
            frmComment.querySelector("button").disabled=true;
        }
        if(frmAttach){
            frmAttach.style.display="none";
            frmAttach.querySelector("input").disabled=true;
            frmAttach.querySelector("button").disabled=true;
        }
    }

    function enableForms(){
        if(frmComment){
            frmComment.style.display="flex";
            frmComment.querySelector("input").disabled=false;
            frmComment.querySelector("button").disabled=false;
        }
        if(frmAttach){
            frmAttach.style.display="flex";
            frmAttach.querySelector("input").disabled=false;
            frmAttach.querySelector("button").disabled=false;
        }
    }

    // Si no hay datos cargados, bloquear todo
    if(!CURRENT_USER || !CURRENT_TICKET){
        adminP.classList.add("d-none");
        disableForms();
        return;
    }

    // Roles reales del usuario (sin SERVER_ADMIN)
    const roles = CURRENT_ROLES || [];
    const isAdmin = roles.includes("admin");
    const isTech = roles.includes("tecnico");

    const userId = CURRENT_USER.id;
    const assignedId = CURRENT_TICKET.assigned_to || null;

    const stateSel = document.getElementById("stateSelect");
    const prioSel = document.getElementById("prioSelect");
    const catSel = document.getElementById("categorySelect");

    const btnSave = document.getElementById("btnSaveMeta");
    const btnStart = document.getElementById("btnStart");
    const btnResolve = document.getElementById("btnResolve");
    const btnClose = document.getElementById("btnClose");
    const btnReopen = document.getElementById("btnReopen");
    const btnAssign = document.getElementById("btnAssign");

    const buttons = [btnSave, btnStart, btnResolve, btnClose, btnReopen];

    // ===============================
    //   LIMPIAR MENSAJES
    // ===============================
    if (assignMsg) {
        assignMsg.textContent = "";
        assignMsg.className = "form-text";
    }
    if (techLockMsg) {
        techLockMsg.classList.add("d-none");
        techLockMsg.textContent = "";
    }

    // ===============================
    //   ADMINISTRADOR (control total)
    // ===============================
    if (isAdmin) {

        adminP.classList.remove("d-none");

        if (techMsg) {
            techMsg.textContent = "Eres administrador: control total.";
        }

      document.getElementById("btnEditTicket").classList.remove("d-none");


        assignSection.classList.remove("d-none");
        btnTake.classList.add("d-none");

        btnAssign.disabled = false;
        stateSel.disabled = false;
        prioSel.disabled = false;
        if (catSel) catSel.disabled = false;

        buttons.forEach(b => b.disabled = false);

        enableForms();
        return;
    }

    // ===============================
    //   T√âCNICO
    // ===============================
    if (isTech) {

        adminP.classList.remove("d-none");

        // ---- Ticket NO asignado todav√≠a ----
        if (!assignedId) {

            if (techMsg) techMsg.textContent = "Ticket sin asignar. Puedes tomarlo.";

            assignSection.classList.add("d-none");
            btnTake.classList.remove("d-none");

            stateSel.disabled = true;
            prioSel.disabled = true;
            if (catSel) catSel.disabled = true;

            buttons.forEach(b => b.disabled = true);

            disableForms();
            return;
        }

      document.getElementById("btnEditTicket").classList.remove("d-none");


        // ---- Ticket asignado a este t√©cnico ----
        if (assignedId === userId) {

            if (techMsg) techMsg.textContent = "Ticket asignado a ti.";

            assignSection.classList.add("d-none");
            btnTake.classList.add("d-none");

            btnAssign.disabled = true;
            stateSel.disabled = false;
            prioSel.disabled = false;
            if (catSel) catSel.disabled = false;

            buttons.forEach(b => b.disabled = false);

            enableForms();

            // üö® Mensaje claro de bloqueo de reasignaci√≥n
            if (techLockMsg) {
                techLockMsg.classList.remove("d-none");
                techLockMsg.textContent =
                    "No puedes asignar el ticket a otro t√©cnico. Solo modificar estado, prioridad y categor√≠a.";
            }

            return;
        }

        // ---- Ticket asignado a otro t√©cnico ----
        if (techMsg) techMsg.textContent = "Asignado a otro t√©cnico.";

        assignSection.classList.add("d-none");
        btnTake.classList.add("d-none");

        stateSel.disabled = true;
        prioSel.disabled = true;
        if (catSel) catSel.disabled = true;

        buttons.forEach(b => b.disabled = true);

        disableForms();

        if (techLockMsg) {
            techLockMsg.classList.remove("d-none");
            techLockMsg.textContent =
                "Este ticket pertenece a otro t√©cnico. No puedes modificarlo.";
        }

        return;
    }

    // ===============================
    //   USUARIO NORMAL
    // ===============================
    adminP.classList.add("d-none");

    if (CURRENT_TICKET.requester === userId) {
        enableForms();
    } else {
        disableForms();
    }
}

document.getElementById("btnEditTicket").classList.remove("d-none");


// =====================================================
//   TABS (carga bajo demanda)
// =====================================================
function initTabs(){
  const buttons=document.querySelectorAll(".ticket-tab-btn");
  const panes=document.querySelectorAll(".ticket-tab-pane");
  let loaded = { comments:false, attachments:false, history:false };

  buttons.forEach(btn=>{
    btn.addEventListener("click",()=>{
      const target=btn.dataset.tabTarget;

      buttons.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");

      panes.forEach(p=>{
        p.classList.toggle("active", p.dataset.tabPane===target);
      });

      if(target==="comments" && !loaded.comments){
        loaded.comments=true; loadComments();
      }
      if(target==="attachments" && !loaded.attachments){
        loaded.attachments=true; loadAttachments();
      }
      if(target==="history" && !loaded.history){
        loaded.history=true; loadHistory();
      }
    });
  });
}

// =====================================================
//   INIT GENERAL
// =====================================================
(async function init(){
  if(!TICKET_ID){
    console.error("No ticket_id");
    return;
  }

  initTabs();

  // stats (user + roles)
  const r = await api("/api/stats/");
  if(r.ok){
    const data=await r.json();
    CURRENT_USER = data.user;
    CURRENT_ROLES = data.user.roles || [];
  }

  await loadPriorities();
  await loadTicket();

  const adminP=document.getElementById("adminPanel");
  if(!adminP.classList.contains("d-none")){
    await loadUsers();
  }

  // precarga comentarios
  loadComments();

  // botones meta
  document.getElementById("btnSaveMeta").onclick =
    ()=> saveMeta(stateSelect.value, prioSelect.value);
  document.getElementById("btnStart").onclick =
    ()=> saveMeta("in_progress", prioSelect.value);
  document.getElementById("btnResolve").onclick =
    ()=> saveMeta("resolved", prioSelect.value);
  document.getElementById("btnClose").onclick =
    ()=> saveMeta("closed", prioSelect.value);
  document.getElementById("btnReopen").onclick =
    ()=> saveMeta("open", prioSelect.value);
})();



// =====================================================
//   EDITAR T√çTULO / DESCRIPCI√ìN
// =====================================================

function enableTicketEditMode() {
    document.getElementById("titleView").classList.add("d-none");
    document.getElementById("editTitle").classList.remove("d-none");
    document.getElementById("editTitle").value = CURRENT_TICKET.title;

    document.getElementById("descriptionView").classList.add("d-none");
    document.getElementById("editDescription").classList.remove("d-none");
    document.getElementById("editDescription").value = CURRENT_TICKET.description;

    document.getElementById("btnEditTicket").classList.add("d-none");
    document.getElementById("btnSaveTicket").classList.remove("d-none");
}

async function saveEditedTicket() {

    const newTitle = document.getElementById("editTitle").value.trim();
    const newDesc  = document.getElementById("editDescription").value.trim();

    if (!newTitle) {
        showToast("El t√≠tulo no puede estar vac√≠o.", "error");
        return;
    }

    const payload = {
        title: newTitle,
        description: newDesc
    };

    const r = await api(`/api/tickets/${TICKET_ID}/`, {
        method: "PATCH",
        body: JSON.stringify(payload)
    });

    if (!r.ok) {
        showToast("Error al guardar los cambios.", "error");
        return;
    }

    const data = await r.json();

    // Actualizar UI
    CURRENT_TICKET.title = data.title;
    CURRENT_TICKET.description = data.description;

    document.getElementById("titleView").textContent = data.title;
    document.getElementById("descriptionView").textContent = data.description;

    // Modo vista normal
    document.getElementById("editTitle").classList.add("d-none");
    document.getElementById("titleView").classList.remove("d-none");

    document.getElementById("editDescription").classList.add("d-none");
    document.getElementById("descriptionView").classList.remove("d-none");

    document.getElementById("btnSaveTicket").classList.add("d-none");
    document.getElementById("btnEditTicket").classList.remove("d-none");

    showToast("Ticket actualizado correctamente", "success");
}

// Asignar eventos a los botones
document.addEventListener("DOMContentLoaded", () => {
    const btnEdit = document.getElementById("btnEditTicket");
    const btnSave = document.getElementById("btnSaveTicket");

    if (btnEdit) btnEdit.onclick = enableTicketEditMode;
    if (btnSave) btnSave.onclick = saveEditedTicket;
});

</script>

{% endblock %}