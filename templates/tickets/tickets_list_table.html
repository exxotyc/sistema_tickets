{% extends "tickets/base.html" %}
{% block title %}{{ title }} · Coyahue{% endblock %}

{% block extra_head %}
<style>
  .glass {
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(15,23,42,.06);
    border-radius: 1rem;
    padding: 1.2rem;
  }

  table.table-coy {
    width: 100%;
    border-collapse: collapse;
    font-size: .9rem;
  }

  table.table-coy th {
    background: rgba(15,23,42,.05);
    font-weight: 600;
    padding: .6rem .5rem;
    border-bottom: 1px solid rgba(15,23,42,.1);
  }

  table.table-coy td {
    padding: .55rem .5rem;
    border-bottom: 1px solid rgba(15,23,42,.06);
  }

  table.table-coy tr:hover {
    background: rgba(15,23,42,.04);
  }

  .badge-pill {
    padding: .3rem .6rem;
    border-radius: 999px;
    font-size: .75rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="glass">

  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2 class="h5 m-0 d-flex align-items-center gap-2">
      <i class="bi bi-table"></i> {{ title }}
    </h2>

    <div>
      <a href="{% url 'ticket_new' %}" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-lg"></i> Nuevo Ticket
      </a>
    </div>
  </div>

  <!-- ================= FILTROS ================= -->
  <form method="get" class="row g-2 mb-3">

    <div class="col-sm-2">
      <select name="state" class="form-select form-select-sm">
        <option value="">Estado (todos)</option>
        <option value="open" {% if filters.state == "open" %}selected{% endif %}>Abiertos</option>
        <option value="in_progress" {% if filters.state == "in_progress" %}selected{% endif %}>En progreso</option>
        <option value="resolved" {% if filters.state == "resolved" %}selected{% endif %}>Resueltos</option>
        <option value="closed" {% if filters.state == "closed" %}selected{% endif %}>Cerrados</option>
      </select>
    </div>

    <div class="col-sm-2">
      <select name="priority" class="form-select form-select-sm">
        <option value="">Prioridad (todas)</option>
        {% for p in priorities %}
          <option value="{{ p.id }}" {% if filters.priority == p.id|stringformat:"s" %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-sm-2">
      <select name="category" class="form-select form-select-sm">
        <option value="">Categoría (todas)</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if filters.category == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-sm-3">
      <input type="text" name="q" value="{{ filters.q }}" placeholder="Buscar…" class="form-control form-control-sm">
    </div>

    <div class="col-sm-2">
      <button class="btn btn-outline-secondary btn-sm w-100">
        <i class="bi bi-funnel"></i> Filtrar
      </button>
    </div>

  </form>

  <!-- ================= TABLA ================= -->
  <div class="table-responsive">
    <table class="table-coy">
      <thead>
        <tr>
          <th>ID</th>
          <th>Título</th>
          <th>Estado</th>
          <th>Prioridad</th>
          <th>Categoría</th>
          {% if show_assignments %}
            <th>Asignado a</th>
          {% endif %}
          <th>Creado</th>
        </tr>
      </thead>

      <tbody>
        {% for t in tickets %}
        <tr data-href="{% url 'ticket_detail' t.id %}" style="cursor:pointer">
        <td>#{{ t.id }}</td>

          <td>{{ t.title|default:"Sin título" }}</td>

          <td>
            {% if t.state == "open" %}
                <span class="badge-pill text-bg-danger">Abierto</span>
            {% elif t.state == "in_progress" %}
                <span class="badge-pill text-bg-warning">En progreso</span>
            {% elif t.state == "resolved" %}
                <span class="badge-pill text-bg-primary">Resuelto</span>
            {% elif t.state == "closed" %}
                <span class="badge-pill text-bg-success">Cerrado</span>
            {% else %}
                <span class="badge-pill text-bg-secondary">{{ t.state }}</span>
            {% endif %}
          </td>

          <td>
            {% if t.priority %}
              {{ t.priority.name }}
            {% else %}
              -
            {% endif %}
          </td>

          <td>
            {% if t.category %}
              {{ t.category.name }}
            {% else %}
              -
            {% endif %}
          </td>

          {% if show_assignments %}
            <td>
              {% if t.assigned_to %}
                {{ t.assigned_to.username }}
              {% else %}
                -
              {% endif %}
            </td>
          {% endif %}

          <td>{{ t.created_at|date:"Y-m-d H:i" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted py-4">
            No hay tickets.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<script>
document.addEventListener("click", e => {
  const row = e.target.closest("tr[data-href]");
  if (row) window.location = row.dataset.href;
});
</script>

{% endblock %}
