{% extends "tickets/base.html" %}
{% block title %}Roles · Mantenedor{% endblock %}

{% block extra_head %}
<style>
  .card-callout{border-left:4px solid #dc3545;background:#fff}
  .role-grid{display:flex;gap:1rem;flex-wrap:wrap}
  .role-grid .form-check{min-width:110px}
  .role-grid .form-check.text-muted label{cursor:not-allowed}
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-body p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="m-0"><i class="bi bi-people-gear me-2"></i>Asignación de roles</h5>
      <a href="{% url 'maint_index' %}" class="btn btn-outline-secondary btn-sm">Volver</a>
    </div>

    <div class="card card-callout mb-3">
      <div class="card-body py-3">
        <ul class="m-0 ps-3 small">
          <li>No dejes el sistema sin al menos <strong>un admin</strong>.</li>
          <li><strong>Admin</strong> y <strong>Técnico</strong> son excluyentes.</li>
          <li><strong>Usuario</strong> es opcional y puede coexistir.</li>
          {% if allowed_roles and managed_roles and allowed_roles|length < managed_roles|length %}
            <li>Solo puedes modificar: {{ allowed_roles|join:', ' }}.</li>
          {% endif %}
        </ul>
      </div>
    </div>

    <form id="roleForm" class="row g-3">
      <div class="col-12 col-md-6">
        <label class="form-label">Usuario</label>
        <select id="userSelect" class="form-select" required>
          <option value="" selected disabled>Selecciona usuario…</option>
          {% for u in users %}
            <option value="{{ u.id }}">{{ u.username }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label">Roles</label>
        <div class="role-grid" id="rolesGrid">
          {% for option in role_options %}
            <div class="form-check">
              <input class="form-check-input role-checkbox" type="checkbox" id="r_{{ option.code }}" value="{{ option.code }}">
              <label class="form-check-label" for="r_{{ option.code }}">{{ option.label }}</label>
            </div>
          {% endfor %}
        </div>
        <div class="form-text">Admin y Técnico no pueden coexistir.</div>
      </div>

      <div class="col-12">
        <button id="btnSave" type="submit" class="btn btn-primary btn-ripple">
          <i class="bi bi-save me-1"></i>Guardar
        </button>
        <span id="msg" class="ms-2 small text-muted"></span>
      </div>
    </form>
  </div>
</div>

{# Embed seguro de roles sin json_script: JSON en data-attribute #}
<div id="rolesMapSrc" data-rolesmap='{{ roles_map_json|escapejs }}' hidden></div>
<div id="rbacInfo"
     data-allowed='{{ allowed_roles_json|default:"[]"|escapejs }}'
     data-managed='{{ managed_roles_json|default:"[]"|escapejs }}'
     data-labels='{{ role_labels_json|default:"{}"|escapejs }}'
     data-can-staff='{{ can_manage_staff|yesno:"true,false" }}'
     hidden></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function(){
  const sel   = document.getElementById("userSelect");
  const admin = document.getElementById("r_admin");
  const tec   = document.getElementById("r_tecnico");
  const usr   = document.getElementById("r_usuario");
  const msg   = document.getElementById("msg");
  const btn   = document.getElementById("btnSave");
  const roleCheckboxes = Array.from(document.querySelectorAll(".role-checkbox"));
  const infoEl = document.getElementById("rbacInfo");

  let allowedRoles = [];
  let managedRoles = [];
  let roleLabels = {};
  if(infoEl){
    try{ allowedRoles = JSON.parse(infoEl.dataset.allowed || "[]"); }catch(_){ allowedRoles = []; }
    try{ managedRoles = JSON.parse(infoEl.dataset.managed || "[]"); }catch(_){ managedRoles = []; }
    try{ roleLabels = JSON.parse(infoEl.dataset.labels || "{}"); }catch(_){ roleLabels = {}; }
  }
  const allowedSet = new Set(allowedRoles);

  // Carga mapa { "<id>":["admin","usuario"], ... } desde data-attribute
  let rolesMap = {};
  try{
    const raw = document.getElementById("rolesMapSrc").dataset.rolesmap || "{}";
    rolesMap = JSON.parse(raw);
  }catch(_){ rolesMap = {}; }

  roleCheckboxes.forEach(cb => {
    const role = cb.value;
    const allowed = allowedSet.has(role);
    cb.dataset.locked = allowed ? "0" : "1";
    cb.disabled = !allowed;
    if(!allowed){
      cb.title = "No tienes permiso para modificar este rol.";
      cb.closest(".form-check").classList.add("text-muted");
    }
  });

  function setMsg(text, ok){
    msg.textContent = text || "";
    msg.className = "ms-2 small " + (ok===true ? "text-success" : ok===false ? "text-danger" : "text-muted");
  }
  function reset(){
    roleCheckboxes.forEach(cb => {
      cb.checked = false;
      cb.disabled = cb.dataset.locked === "1";
    });
  }
  function enforceExclusion(){
    const adminLocked = admin.dataset.locked === "1";
    const tecLocked = tec.dataset.locked === "1";

    if(admin.checked){
      tec.checked = false;
      if(!tecLocked){ tec.disabled = true; }
    }else if(!tecLocked){
      tec.disabled = false;
    }

    if(tec.checked){
      admin.checked = false;
      if(!adminLocked){ admin.disabled = true; }
    }else if(!adminLocked){
      admin.disabled = false;
    }

    if(adminLocked){ admin.disabled = true; }
    if(tecLocked){ tec.disabled = true; }
  }
  admin.addEventListener("change", enforceExclusion);
  tec.addEventListener("change", enforceExclusion);

  sel.addEventListener("change", ()=>{
    reset(); setMsg("", null);
    const uid = sel.value;
    const roles = rolesMap[String(uid)] || [];
    roles.forEach(r=>{
      if(r==="admin")   admin.checked = true;
      if(r==="tecnico") tec.checked   = true;
      if(r==="usuario") usr.checked   = true;
    });
    enforceExclusion();
  });

  async function refreshUsers(){
    try{
      const response = await fetch("{% url 'roles_data' %}");
      if(!response.ok) return;
      const payload = await response.json();
      const list = Array.isArray(payload.users) ? payload.users : [];
      const previous = sel.value;

      const frag = document.createDocumentFragment();
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.disabled = true;
      placeholder.selected = true;
      placeholder.textContent = "Selecciona usuario…";
      frag.appendChild(placeholder);

      rolesMap = {};
      list.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = item.username || item.raw_username || `#${item.id}`;
        frag.appendChild(opt);
        rolesMap[String(item.id)] = Array.isArray(item.roles) ? item.roles : [];
      });

      sel.innerHTML = "";
      sel.appendChild(frag);

      if(previous && rolesMap[String(previous)]){
        sel.value = previous;
      }

      if(sel.value){
        sel.dispatchEvent(new Event("change"));
      }else{
        sel.selectedIndex = 0;
      }
    }catch(_){ /* ignore network errors */ }
  }

  document.getElementById("roleForm").addEventListener("submit", async (ev)=>{
    ev.preventDefault(); setMsg("", null);
    const uid = sel.value;
    if(!uid){ setMsg("Selecciona un usuario.", false); return; }

    const roles = [];
    if(admin.checked) roles.push("admin");
    if(tec.checked)   roles.push("tecnico");
    if(usr.checked)   roles.push("usuario");
    if(roles.includes("admin") && roles.includes("tecnico")){
      setMsg("No puedes combinar admin y técnico.", false);
      return;
    }

    btn.disabled = true;
    try{
      const r = await fetch("{% url 'maint_roles_set' %}", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ user_id: Number(uid), roles })
      });
      const data = await r.json().catch(()=>({}));
      if(!r.ok){
        setMsg(data.error || "Error al guardar", false);
      }else{
        rolesMap[String(uid)] = data.roles || [];
        setMsg("Roles actualizados.", true);
        await refreshUsers();
      }
    }catch(_){ setMsg("Fallo de red.", false); }
    finally{ btn.disabled = false; }
  });

  if(sel.options.length > 1){ sel.selectedIndex = 1; sel.dispatchEvent(new Event("change")); }
  refreshUsers();
});
</script>
{% endblock %}
