{% extends "tickets/base.html" %}
{% block title %}Nuevo ticket · Coyahue{% endblock %}

{% block extra_head %}
<style>
  .glass {
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(15,23,42,.06);
    border-radius: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="glass p-3 p-md-4" id="new-root"
     data-is-admin-or-tecnico="{% if is_admin_or_tecnico %}1{% else %}0{% endif %}"
     data-from-faq="{{ from_faq|default:'' }}"
     data-from-faq-cat="{{ from_faq_category|default:'' }}"
>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 m-0 d-flex align-items-center gap-2">
      <i class="bi bi-plus-square"></i> Nuevo ticket
    </h1>
    <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary btn-sm btn-ripple" data-hard-nav="1">
      <i class="bi bi-arrow-left"></i> Volver
    </a>
  </div>

  <!-- ⭐⭐⭐ BLOQUE AÑADIDO: Banner FAQ -->
  {% if from_faq %}
  <div class="alert alert-info d-flex align-items-center gap-2">
    <i class="bi bi-info-circle"></i>
    Este ticket fue iniciado desde una pregunta frecuente.
  </div>
  {% endif %}
  <!-- ⭐⭐⭐ FIN BLOQUE AÑADIDO -->

  <form id="frmNew" class="row g-3">

    <div class="col-12">
      <label class="form-label">Título</label>
      <input id="title" class="form-control" required maxlength="200">
    </div>

    <div class="col-12">
      <label class="form-label">Descripción</label>
      <textarea id="description" class="form-control" rows="5" required></textarea>
    </div>

    <div class="col-md-6" id="priority-wrapper" style="display:none;">
      <label class="form-label">Prioridad</label>
      <select id="priority" class="form-select">
        <option disabled selected>Cargando prioridades…</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Categoría</label>
      <select id="category" class="form-select">
        <option value="">Sin categoría</option>
      </select>
    </div>

    <div class="col-12 d-flex gap-2 mt-2">
      <button class="btn btn-primary btn-ripple" type="submit">
        <i class="bi bi-save"></i> Crear
      </button>
      <button class="btn btn-outline-secondary btn-ripple" type="button" id="btnCancel">
        Cancelar
      </button>
    </div>

    <div id="msg" class="form-text mt-2"></div>

  </form>
</div>
{% endblock %}

{% block auth_protect %}
<script>
(async ()=>{
  const access = localStorage.getItem("access_token");
  if(!access){ location.assign("/"); return; }

  try{
    const r = await fetch("/api/stats/", { headers:{ Authorization:"Bearer "+access }});
    if(r.ok) return;
  }catch(_){}

  const refresh = localStorage.getItem("refresh_token");
  if(!refresh){ localStorage.clear(); location.assign("/"); return; }

  const rr = await fetch("/api/token/refresh/", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ refresh })
  });

  if(!rr.ok){ localStorage.clear(); location.assign("/"); return; }

  const data = await rr.json();
  localStorage.setItem("access_token", data.access);
})();
</script>
{% endblock %}

{% block extra_js %}
<script>
(function()
            {
  function authHeader(){
    const a = localStorage.getItem("access_token");
    return a ? { Authorization: "Bearer " + a } : {};
  }

  async function api(url, opts={}){
    const r = await fetch(url, {
      ...opts,
      headers: {
        ...(opts.headers || {}),
        ...authHeader(),
        ...(opts.body && !opts.headers?.["Content-Type"] && !(opts.body instanceof FormData)
          ? { "Content-Type": "application/json" }
          : {})
      }
    });
    return r;
  }

  const root = document.getElementById("new-root");
  const isAdminOrTec = root?.dataset.isAdminOrTecnico === "1";
  // Primero leer parámetros URL (si existe)
  const params = new URLSearchParams(window.location.search);
  const fromFaqParam = params.get("fromfaq") || "";
  const fromFaqCatParam = params.get("fromfaqcat") || params.get("fromfaq_cat") || "";
  // Dataset tiene prioridad si la plantilla lo estableció
  const fromFAQ = root?.dataset.fromFaq || fromFaqParam || "";
  // categoría sugerida desde FAQ (id o nombre parcial). Dataset tiene prioridad.
  const catFromFAQ = root?.dataset.fromFaqCat || fromFaqCatParam || "";

  const priorityWrapper = document.getElementById("priority-wrapper");
  const prioritySelect  = document.getElementById("priority");
  const categorySelect  = document.getElementById("category");
  const msgEl           = document.getElementById("msg");
  const titleEl         = document.getElementById("title");
  const descEl          = document.getElementById("description");

  // Autorrellenar si viene desde FAQ
  if(fromFAQ){
    titleEl.value = `[FAQ] ${fromFAQ}`;
    descEl.value = `El usuario reporta que la siguiente pregunta de FAQ NO resolvió su problema:\n\n"${fromFAQ}"\n\nDescripción adicional: `;
    msgEl.textContent = "Esta solicitud fue iniciada desde una Pregunta Frecuente.";
    msgEl.className = "form-text text-primary fw-bold";
  }

  // Mostrar/ocultar campo prioridad según rol
  if(isAdminOrTec && priorityWrapper){
    priorityWrapper.style.display = "";
  }

  // Cargar categorías
  (async ()=>{
    try{
      const r = await api("/api/categories/");
      if(!r.ok) return;
      const data = await r.json();
      categorySelect.innerHTML = '<option value="">Sin categoría</option>';
      (data.results || data).forEach(c=>{
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = c.name;
        categorySelect.appendChild(o);
      });

      // ⭐⭐⭐ preseleccionar categoría del FAQ (si viene el id o nombre)
      if(catFromFAQ){
        // intentar como id primero
        const asString = String(catFromFAQ);
        const byValue = Array.from(categorySelect.options).find(o => o.value === asString);
        if(byValue){
          categorySelect.value = asString;
        }else{
          // intentar por nombre parcial (case-insensitive)
          const lower = asString.toLowerCase();
          const byText = Array.from(categorySelect.options).find(o => o.textContent.toLowerCase().includes(lower));
          if(byText){
            categorySelect.value = byText.value;
          }
        }
      }

    }catch(e){
      console.error("Error cargando categorías", e);
    }
  })();

  // Cargar prioridades (solo si el wrapper está visible)
  if(isAdminOrTec){
    (async ()=>{
      try{
        const r = await api("/api/priorities/");
        if(!r.ok){
          prioritySelect.innerHTML = '<option disabled>Error cargando prioridades</option>';
          return;
        }
        const data = await r.json();
        const items = data.results || data;
        if(!items.length){
          prioritySelect.innerHTML = '<option disabled>No hay prioridades definidas</option>';
          return;
        }
        prioritySelect.innerHTML = "";
        items.forEach(p=>{
          const o = document.createElement("option");
          o.value = p.id;
          o.textContent = `${p.name} (${p.code})`;
          prioritySelect.appendChild(o);
        });
      }catch(e){
        console.error("Error cargando prioridades", e);
        prioritySelect.innerHTML = '<option disabled>Error cargando prioridades</option>';
      }
    })();
  }

  // Botón cancelar
  document.getElementById("btnCancel").addEventListener("click", (e)=>{
    e.preventDefault();
    window.location.assign("{% url 'ticket_list' %}");
  });

  // Crear ticket
  document.getElementById("frmNew").addEventListener("submit", async (e)=>{
    e.preventDefault();
    msgEl.textContent = "";
    msgEl.className = "form-text";

    const title = titleEl.value.trim();
    const description = descEl.value.trim();
    const category = categorySelect.value || null;

    if(!title || !description){
      msgEl.textContent = "Completa título y descripción.";
      msgEl.className = "form-text text-danger";
      return;
    }

    let priority = null;
    if(isAdminOrTec && prioritySelect && prioritySelect.value){
      priority = prioritySelect.value;
    }

    const payload = {
      title,
      description,
      category,
      priority
    };

    try{
      const r = await api("/api/tickets/", {
        method: "POST",
        body: JSON.stringify(payload)
      });

      if(!r.ok){
        let txt = "No se pudo crear el ticket.";
        try{
          const j = await r.json();
          txt = j.detail || j.error || JSON.stringify(j);
        }catch{}
        msgEl.textContent = txt;
        msgEl.className = "form-text text-danger";
        return;
      }

      const t = await r.json();
      if(t && t.id){
        window.location.assign(`/tickets/${t.id}/`);
      }else{
        msgEl.textContent = "Ticket creado pero no se recibió ID.";
        msgEl.className = "form-text text-warning";
      }
    }catch(err){
      console.error("Error creando ticket", err);
      msgEl.textContent = "Error inesperado al crear el ticket.";
      msgEl.className = "form-text text-danger";
    }
  });

})();
</script>
{% endblock %}