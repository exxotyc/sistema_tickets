{% extends "tickets/base.html" %}
{% block title %}Nuevo ticket · Coyahue{% endblock %}

{% block extra_head %}
<style>
  .glass {
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(15,23,42,.06);
    border-radius: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="glass p-3 p-md-4" id="new-root"
     data-is-admin-or-tecnico="{% if is_admin_or_tecnico %}1{% else %}0{% endif %}"
     data-from-faq="{{ from_faq|default:'' }}"
     data-from-faq-cat="{{ from_faq_category|default:'' }}"
>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 m-0 d-flex align-items-center gap-2">
      <i class="bi bi-plus-square"></i> Nuevo ticket
    </h1>
    <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary btn-sm btn-ripple" data-hard-nav="1">
      <i class="bi bi-arrow-left"></i> Volver
    </a>
  </div>

  {% if from_faq %}
  <div class="alert alert-info d-flex align-items-center gap-2">
    <i class="bi bi-info-circle"></i>
    Este ticket fue iniciado desde una pregunta frecuente.
  </div>
  {% endif %}

  <form id="frmNew" class="row g-3">

    <div class="col-12">
      <label class="form-label">Título</label>
      <input id="title" class="form-control" required maxlength="200">
    </div>

    <div class="col-12">
      <label class="form-label">Descripción</label>
      <textarea id="description" class="form-control" rows="5" required></textarea>
    </div>

    <div class="col-md-6" id="priority-wrapper" style="display:none;">
      <label class="form-label">Prioridad</label>
      <select id="priority" class="form-select">
        <option disabled selected>Cargando prioridades…</option>
      </select>
    </div>

   {% if is_admin_or_tecnico %}
<div class="col-md-6">
  <label class="form-label">Categoría</label>
  <select id="category" class="form-select">
    <option value="">Sin categoría</option>
  </select>
</div>
{% else %}
<!-- Usuario normal NO debe ver categoría -->
<input type="hidden" id="category" value="">
{% endif %}

    <div class="col-12 d-flex gap-2 mt-2">
      <button class="btn btn-primary btn-ripple" type="submit">
        <i class="bi bi-save"></i> Crear
      </button>
      <button class="btn btn-outline-secondary btn-ripple" type="button" id="btnCancel">
        Cancelar
      </button>
    </div>

    <div id="msg" class="form-text mt-2"></div>

  </form>
</div>
{% endblock %}

{% block auth_protect %}
<script>
(async ()=>{
  const access = localStorage.getItem("access_token");
  if(!access){ location.assign("/"); return; }

  try{
    const r = await fetch("/api/stats/", { headers:{ Authorization:"Bearer "+access }});
    if(r.ok) return;
  }catch(_){}

  const refresh = localStorage.getItem("refresh_token");
  if(!refresh){ localStorage.clear(); location.assign("/"); return; }

  const rr = await fetch("/api/token/refresh/", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ refresh })
  });

  if(!rr.ok){ localStorage.clear(); location.assign("/"); return; }

  const data = await rr.json();
  localStorage.setItem("access_token", data.access);
})();
</script>
{% endblock %}

{% block extra_js %}
<script>
(function(){

  /* ======================================================
      FIX: LECTURA DE COOKIE CSRF
  ====================================================== */
  function getCookie(name){
    const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : "";
  }

  /* ======================================================
      AUTH HEADER
  ====================================================== */
  function authHeader(){
    const a = localStorage.getItem("access_token");
    return a ? { Authorization: "Bearer " + a } : {};
  }

  /* ======================================================
      FIX COMPLETO: API() CON CSRF AUTOMÁTICO
  ====================================================== */
  async function api(url, opts={}){
    const method = (opts.method || "GET").toUpperCase();
    const headers = {
      ...(opts.headers || {}),
      ...authHeader()
    };

    const hasBody = !!opts.body;

    // Para métodos que modifican datos → agregar CSRF
    if(["POST","PUT","PATCH","DELETE"].includes(method)){
      if(hasBody && !(opts.body instanceof FormData)){
        headers["Content-Type"] = "application/json";
      }
      headers["X-CSRFToken"] = getCookie("csrftoken");
    }

    return fetch(url, { ...opts, headers });
  }

  /* ======================================================
      VARIABLES
  ====================================================== */
  const root = document.getElementById("new-root");
  const isAdminOrTec = root?.dataset.isAdminOrTecnico === "1";

  const params = new URLSearchParams(window.location.search);
  const fromFAQ = root?.dataset.fromFaq || params.get("fromfaq") || "";
  const catFromFAQ = root?.dataset.fromFaqCat || params.get("fromfaqcat") || params.get("fromfaq_cat") || "";

  const priorityWrapper = document.getElementById("priority-wrapper");
  const prioritySelect  = document.getElementById("priority");
  const categorySelect  = document.getElementById("category");
  const msgEl           = document.getElementById("msg");
  const titleEl         = document.getElementById("title");
  const descEl          = document.getElementById("description");

  /* ======================================================
      AUTORELLENO DESDE FAQ
  ====================================================== */
  if(fromFAQ){
    titleEl.value = `[FAQ] ${fromFAQ}`;
    descEl.value = `El usuario reporta que la siguiente pregunta de FAQ NO resolvió su problema:\n\n"${fromFAQ}"\n\nDescripción adicional: `;
    msgEl.textContent = "Esta solicitud fue iniciada desde una Pregunta Frecuente.";
    msgEl.className = "form-text text-primary fw-bold";
  }

  if(isAdminOrTec && priorityWrapper){
    priorityWrapper.style.display = "";
  }

  /* ======================================================
      CARGA DE CATEGORÍAS
  ====================================================== */
  (async ()=>{
    try{
      const r = await api("/api/categories/");
      if(!r.ok) return;
      const data = await r.json();

      categorySelect.innerHTML = '<option value="">Sin categoría</option>';

      (data.results || data).forEach(c=>{
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = c.name;
        categorySelect.appendChild(o);
      });

      if(catFromFAQ){
        const str = String(catFromFAQ).toLowerCase();
        const opt = Array.from(categorySelect.options).find(o =>
          o.value === str || o.textContent.toLowerCase().includes(str)
        );
        if(opt) categorySelect.value = opt.value;
      }

    }catch(e){
      console.error("Error cargando categorías", e);
    }
  })();

  /* ======================================================
      CARGA DE PRIORIDADES
  ====================================================== */
  if(isAdminOrTec){
    (async ()=>{
      try{
        const r = await api("/api/priorities/");
        if(!r.ok){
          prioritySelect.innerHTML = '<option disabled>Error cargando prioridades</option>';
          return;
        }
        const data = await r.json();
        const items = data.results || data;

        prioritySelect.innerHTML = "";
        items.forEach(p=>{
          const o = document.createElement("option");
          o.value = p.id;
          o.textContent = `${p.name} (${p.code})`;
          prioritySelect.appendChild(o);
        });

      }catch(e){
        console.error("Error cargando prioridades", e);
        prioritySelect.innerHTML = '<option disabled>Error cargando prioridades</option>';
      }
    })();
  }

  /* ======================================================
      BOTÓN CANCELAR
  ====================================================== */
  document.getElementById("btnCancel").addEventListener("click", (e)=>{
    e.preventDefault();
    window.location.assign("{% url 'ticket_list' %}");
  });

  /* ======================================================
      CREAR TICKET
  ====================================================== */
  document.getElementById("frmNew").addEventListener("submit", async (e)=>{
    e.preventDefault();
    msgEl.textContent = "";
    msgEl.className = "form-text";

    const title = titleEl.value.trim();
    const description = descEl.value.trim();
    const category = categorySelect.value || null;

    if(!title || !description){
      msgEl.textContent = "Completa título y descripción.";
      msgEl.className = "form-text text-danger";
      return;
    }

    let priority = null;
    if(isAdminOrTec && prioritySelect.value){
      priority = prioritySelect.value;
    }

    const payload = {
      title,
      description,
      category,
      priority
    };

    try{
      const r = await api("/api/tickets/", {
        method: "POST",
        body: JSON.stringify(payload)
      });

      if(!r.ok){
        let txt = "No se pudo crear el ticket.";
        try{
          const j = await r.json();
          txt = j.detail || j.error || JSON.stringify(j);
        }catch{}
        msgEl.textContent = txt;
        msgEl.className = "form-text text-danger";
        return;
      }

      const t = await r.json();
      if(t && t.id){
        window.location.assign(`/tickets/${t.id}/`);
      }else{
        msgEl.textContent = "Ticket creado pero no se recibió ID.";
        msgEl.className = "form-text text-warning";
      }

    }catch(err){
      console.error("Error creando ticket", err);
      msgEl.textContent = "Error inesperado al crear el ticket.";
      msgEl.className = "form-text text-danger";
    }
  });

})();
</script>
{% endblock %}
