{% extends "tickets/base.html" %}
{% block title %}FAQ ¬∑ Coyahue{% endblock %}

{% block extra_head %}
<style>
/* ================================
      CONTENEDOR PRINCIPAL
================================ */
.faq-wrapper {
    height: 78vh;                 /* Altura real del m√≥dulo */
    display: flex;
    flex-direction: column;
}

/* ================================
      √ÅREA DE SCROLL
================================ */
.faq-content {
    flex: 1;                      /* Ocupa todo el espacio sobrante */
    overflow-y: auto;             
    overflow-x: hidden;           
    padding-right: 6px;           
    padding-bottom: 10px;         
}

/* Scrollbar Chrome */
.faq-content::-webkit-scrollbar {
    width: 7px;
}
.faq-content::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.25);
    border-radius: 8px;
}
.faq-content::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.35);
}

/* Scrollbar Firefox */
.faq-content {
    scrollbar-color: rgba(0,0,0,0.35) transparent;
    scrollbar-width: thin;
}

/* ================================
      TARJETAS FAQ
================================ */
.glass{
    background:rgba(255,255,255,.90);
    backdrop-filter:blur(7px);
    border:1px solid rgba(15,23,42,.06);
    border-radius:1rem;
}

.faq-card{
    transition:all .25s ease;
    cursor:pointer;
    border-radius:1rem;
}

.faq-card:hover{
    transform:translateY(-2px);
    box-shadow:0 12px 28px rgba(0,0,0,.15);
}

/* ================================
      ANIMACI√ìN APARECER
================================ */
.fade-in{
    animation:fadeIn .4s ease;
}
@keyframes fadeIn{
    from{opacity:0; transform:translateY(6px);}
    to{opacity:1; transform:none;}
}

/* ================================
      EXPANDIR / COLAPSAR
================================ */
.faq-full {
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition: all .35s ease;
}

.faq-full.visible {
    opacity: 1;
    max-height: 500px;
}

</style>

{% endblock %}

{% block content %}

<div class="glass p-3 p-md-4 fade-in faq-wrapper">

    <!-- T√çTULO -->
    <div class="mb-3">
        <h2 class="h5 d-flex align-items-center gap-2">
            <i class="bi bi-question-circle text-primary"></i> Preguntas Frecuentes
        </h2>
    </div>

    <!-- BUSCADOR -->
    <div class="mb-3">
        <input id="search" class="form-control form-control-lg" placeholder="Buscar respuesta‚Ä¶">
    </div>

    <!-- CATEGOR√çAS -->
    <div class="d-flex gap-2 flex-wrap mb-3" id="catContainer">
        <button data-cat="all" class="btn btn-sm btn-outline-primary active">Todas</button>
    </div>

    <!-- LISTADO CON SCROLL -->
    <div class="faq-content">
        <div id="faqContainer" class="row g-3">
            <div class="text-center text-muted py-5">Cargando preguntas‚Ä¶</div>
        </div>
    </div>

</div>

{% endblock %}


{% block extra_js %}
<script>
// ======================================================
// Manejo de tokens y helper API
// ======================================================
async function ensureAccessToken() {
  // Devuelve token v√°lido o null
  let access = localStorage.getItem("access_token");
  if (access) return access;

  const refresh = localStorage.getItem("refresh_token");
  if (refresh) {
    try {
      const rr = await fetch("/api/token/refresh/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ refresh })
      });
      if (rr.ok) {
        const d = await rr.json();
        localStorage.setItem("access_token", d.access);
        return d.access;
      }
    } catch (e) { /* ignore */ }
  }

  // ============================
  // FIX: Solicitar token de sesi√≥n con CSRF
  // ============================
  try {
    const csrftoken = getCookie("csrftoken");

    const rs = await fetch("/api/token/session/", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken
      }
    });

    if (rs.ok) {
      const ds = await rs.json();
      if (ds.access) localStorage.setItem("access_token", ds.access);
      if (ds.refresh) localStorage.setItem("refresh_token", ds.refresh);
      return ds.access || null;
    }
  } catch (e) {
    console.error("No se pudo obtener token de sesi√≥n", e);
  }

  return null;
}

// Helper:
function getCookie(name){
    const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : "";
}

async function tryRefreshAndRetry(originalRequest) {
  const refresh = localStorage.getItem("refresh_token");
  if (!refresh) return null;
  try {
    const rr = await fetch("/api/token/refresh/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh })
    });
    if (!rr.ok) return null;
    const d = await rr.json();
    localStorage.setItem("access_token", d.access);
    // re-intentar la petici√≥n original con nuevo token
    const headers = {
      ...(originalRequest.headers || {}),
      Authorization: "Bearer " + d.access
    };
    return fetch(originalRequest.url, { ...originalRequest.opts, headers });
  } catch (e) {
    console.error("Refresh failed", e);
    return null;
  }
}

// apiFetch: asegura token y reintenta 1 vez en 401
async function apiFetch(url, opts = {}) {
  const full = url.startsWith("/api") ? url : "/api" + url;

  // asegurar token
  const token = await ensureAccessToken();
  const headers = {
    ...(opts.headers || {}),
    ...(token ? { Authorization: "Bearer " + token } : {})
  };

  let res;
  try {
    res = await fetch(full, { ...opts, headers });
  } catch (e) {
    throw e;
  }

  if (res.status === 401) {
    // intentar refrescar y reintentar una vez
    const retried = await tryRefreshAndRetry({ url: full, opts });
    if (retried) return retried;
  }

  return res;
}

// ======================================================
// Utilidades de UI
// ======================================================
function esc(s){
  return String(s||"").replace(/[&<>"']/g, m => ({
    '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
  })[m]);
}

// ======================================================
// Cargar categor√≠as
// ======================================================
async function loadCategories(){
  try{
    const r = await apiFetch("/api/categories/");
    if(!r.ok){
      // si no autorizado o no hay datos, mostrar bot√≥n "Todas" y fallar silencioso
      console.warn("Categorias: status", r.status);
      return;
    }

    const cats = await r.json();
    const container = document.getElementById("catContainer");

    (cats.results || cats).forEach(c=>{
      const btn = document.createElement("button");
      btn.className = "btn btn-sm btn-outline-primary";
      btn.textContent = c.name;
      btn.dataset.cat = c.id;
      container.appendChild(btn);
    });

  }catch(err){
    console.error("Error cargando categor√≠as", err);
  }
}

// ======================================================
// Cargar FAQs
// ======================================================
let ALL_FAQ = [];

async function loadFAQ(){
  try{
    const r = await apiFetch("/api/faqs/");
    if(!r.ok){
      console.warn("FAQs: status", r.status);
      const cont = document.getElementById("faqContainer");
      cont.innerHTML = '<div class="text-center text-muted py-5">No se pudieron cargar preguntas</div>';
      return;
    }

    const data = await r.json();
    ALL_FAQ = data.results || data;
    renderFAQ(ALL_FAQ);

  }catch(err){
    console.error("Error cargando FAQs", err);
    const cont = document.getElementById("faqContainer");
    cont.innerHTML = '<div class="text-center text-muted py-5">Error cargando preguntas</div>';
  }
}

// ======================================================
// Render FAQ
// ======================================================
function renderFAQ(list){
  const cont = document.getElementById("faqContainer");

  if(!list.length){
    cont.innerHTML = '<div class="text-center text-muted py-5">Sin resultados</div>';
    return;
  }

  cont.innerHTML = "";

  list.forEach(f => {
    const div = document.createElement("div");
    div.className = "col-md-6";

    const fullText = esc(f.answer || "");
    const shortText = fullText.slice(0,120);

    div.innerHTML = `
      <div class="faq-card glass faq-animate p-3" data-faq-id="${f.id}">

        <h6 class="mb-2 faq-title" style="cursor:pointer">
          ${esc(f.question)}
        </h6>

        <p class="text-muted small mb-2 faq-short">
          ${esc(shortText)}...
          <span class="text-primary">ver m√°s</span>
        </p>

        <p class="text-muted small mb-2 faq-full">
          ${fullText}
          <br><span class="text-primary">ver menos</span>
        </p>

        <span class="badge text-bg-light">${esc(f.category_name || "General")}</span>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-success btn-sm" data-yes="${f.id}">
            <i class="bi bi-hand-thumbs-up"></i> √ötil
          </button>
          <button class="btn btn-outline-danger btn-sm" data-no="${f.id}">
            <i class="bi bi-hand-thumbs-down"></i> No √∫til
          </button>
        </div>

      </div>
    `;

    cont.appendChild(div);
  });

  // ===============================
  // EXPANSI√ìN ANIMADA
  // ===============================
  document.querySelectorAll(".faq-card").forEach(card => {
    const shortEl = card.querySelector(".faq-short");
    const fullEl  = card.querySelector(".faq-full");
    
    const toggle = () => {
      const open = card.classList.contains("faq-open");

      if (open) {
        // cerrar
        card.classList.remove("faq-open");
        fullEl.classList.remove("visible");
        shortEl.style.display = "";
      } else {
        // abrir
        card.classList.add("faq-open");
        shortEl.style.display = "none";
        fullEl.classList.add("visible");
      }
    };

    card.querySelector(".faq-title").onclick = toggle;
    shortEl.onclick = toggle;
    fullEl.onclick = toggle;
  });
}



// ======================================================
// Filtro por categor√≠a
// ======================================================
document.getElementById("catContainer").onclick = e => {
  const btn = e.target.closest("button");
  if(!btn) return;

  [...document.querySelectorAll("#catContainer button")].forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");

  const cat = btn.dataset.cat;

  if(cat === "all"){
    renderFAQ(ALL_FAQ);
  } else {
    renderFAQ( ALL_FAQ.filter(f => Number(f.category) === Number(cat)) );
  }
};

// ======================================================
// Buscador
// ======================================================
document.getElementById("search").oninput = e => {
  const q = e.target.value.toLowerCase();

  const filtered = ALL_FAQ.filter(f =>
    (f.question || "").toLowerCase().includes(q) ||
    (f.answer || "").toLowerCase().includes(q)
  );

  renderFAQ(filtered);
};

// ======================================================
// Feedback (√ötil / No √∫til)
// ======================================================
document.getElementById("faqContainer").onclick = async e => {
  const yesBtn = e.target.closest("button[data-yes]");
  const noBtn  = e.target.closest("button[data-no]");

  try{
    // üëç √ötil
    if (yesBtn) {
      const id = yesBtn.dataset.yes;

      const r = await apiFetch(`/api/faqs/${id}/useful/`, { method: "POST" });
      if (!r.ok) throw new Error("feedback failed");

      alert("¬°Gracias! Esta informaci√≥n fue √∫til.");
      return;
    }

    // üëé No √∫til
    if (noBtn) {
      const id = noBtn.dataset.no;

      const r = await apiFetch(`/api/faqs/${id}/unresolved/`, { method: "POST" });
      if (!r.ok) throw new Error("feedback failed");

      const faq = ALL_FAQ.find(f => String(f.id) === String(id));
      const q = faq ? faq.question : "";

      alert("Gracias, te ayudaremos creando un ticket.");
      location.href = `/tickets/new/?fromfaq=${encodeURIComponent(q)}`;
      return;
    }

  }catch(err){
    console.error("Error enviando feedback", err);
    alert("Ocurri√≥ un error al registrar tu respuesta.");
  }
};

// ======================================================
// INIT
// ======================================================
(function(){
  // iniciar flujo token en background (para reducir 401s iniciales)
  ensureAccessToken().catch(()=>{ /* ignorable */ });

  loadCategories();
  loadFAQ();
})();
</script>
{% endblock %}