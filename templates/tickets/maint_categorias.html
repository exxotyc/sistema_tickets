{% extends "tickets/base.html" %}
{% block title %}Mantenedor · Categorías{% endblock %}

{% block extra_head %}
<style>
  .glass{background:rgba(255,255,255,.92);backdrop-filter:blur(6px);border:1px solid rgba(15,23,42,.06);border-radius:1rem}
  .row-gap{row-gap:12px}

  /* Scroll personalizado para la tabla */
  .table-scroll-wrapper {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid rgba(15,23,42,.06);
    border-radius: 0.5rem;
  }

  /* Personalizar scrollbar webkit (Chrome, Safari, Edge) */
  .table-scroll-wrapper::-webkit-scrollbar {
    width: 8px;
  }

  .table-scroll-wrapper::-webkit-scrollbar-track {
    background: rgba(15,23,42,.04);
    border-radius: 4px;
  }

  .table-scroll-wrapper::-webkit-scrollbar-thumb {
    background: rgba(15,23,42,.2);
    border-radius: 4px;
    transition: background 0.2s ease;
  }

  .table-scroll-wrapper::-webkit-scrollbar-thumb:hover {
    background: rgba(15,23,42,.4);
  }

  /* Firefox */
  .table-scroll-wrapper {
    scrollbar-color: rgba(15,23,42,.2) rgba(15,23,42,.04);
    scrollbar-width: thin;
  }

  /* Asegurar que la tabla sea responsive */
  .table-scroll-wrapper .table {
    margin-bottom: 0;
  }
</style>
{% endblock %}

{% block content %}
<div class="glass p-3 p-md-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 m-0 d-flex align-items-center gap-2"><i class="bi bi-folder-gear"></i> Categorías</h1>
    <a class="btn btn-outline-secondary btn-sm btn-ripple" href="{% url 'maint_index' %}">Volver</a>
  </div>

  <form id="frmNew" class="row g-2 row-gap align-items-end mb-3">
    <div class="col-sm-7 col-md-8">
      <label class="form-label m-0">Nombre</label>
      <input id="newName" class="form-control" placeholder="Ej. Red/Internet" required>
    </div>
    <div class="col-sm-5 col-md-4 d-grid">
      <button class="btn btn-primary btn-ripple" type="submit"><i class="bi bi-plus-lg me-1"></i>Crear</button>
    </div>
  </form>

  <div class="input-group mb-3">
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input id="q" class="form-control" placeholder="Buscar…">
  </div>

  <!-- TABLA CON SCROLL -->
  <div class="table-scroll-wrapper">
    <table class="table table-hover align-middle">
      <thead class="table-light" style="position: sticky; top: 0;">
        <tr>
          <th style="width:90px">ID</th>
          <th>Nombre</th>
          <th style="width:160px"></th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="3" class="text-center text-muted py-4">Cargando…</td></tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* ============================================================
      ESCAPAR STRINGS PARA EVITAR XSS EN INPUTS
============================================================ */
function esc(s){
    return String(s || "").replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;', '"':'&quot;', "'":'&#39;'
    }[m]));
}

/* ============================================================
      OBTENER CSRF DESDE LAS COOKIES (Django)
============================================================ */
function getCSRFToken(){
    const cookie = document.cookie
        .split("; ")
        .find(row => row.startsWith("csrftoken="));
    return cookie ? cookie.split("=")[1] : "";
}

/* ============================================================
      API WRAPPER — AGREGA JWT AUTOMÁTICAMENTE
============================================================ */
async function apiFetch(url, opts = {}){
    const t = localStorage.getItem("access_token");

    if(!t){
        alert("Sesión inválida");
        return null;
    }

    // Inyectamos Authorization + dejamos extender headers
    const r = await fetch(url, {
        ...opts,
        headers:{
            ...(opts.headers || {}),
            Authorization: "Bearer " + t
        }
    });

    if(r.status === 401){
        alert("No autorizado");
        return null;
    }

    return r;
}

let allItems = [];

/* ============================================================
      RENDERIZAR TABLA
============================================================ */
function render(list){
    const tb = document.getElementById("rows");

    if(!list.length){
        tb.innerHTML = `
            <tr>
                <td colspan="3" class="text-center text-muted py-4">
                    Sin categorías
                </td>
            </tr>`;
        return;
    }

    tb.innerHTML = "";

    for(const c of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${c.id}</td>
            <td>
                <input class="form-control form-control-sm"
                       value="${esc(c.name || "")}"
                       data-id="${c.id}">
            </td>
            <td class="text-end">
                <button class="btn btn-sm btn-outline-primary me-1"
                        data-act="save" data-id="${c.id}">
                    <i class="bi bi-save"></i> Guardar
                </button>
                <button class="btn btn-sm btn-outline-danger"
                        data-act="del" data-id="${c.id}">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
            </td>`;
        tb.appendChild(tr);
    }
}

/* ============================================================
      CARGAR CATEGORÍAS DESDE LA API
============================================================ */
async function load(){
    const r = await apiFetch("/api/categories/");
    if(!r) return;

    const data = await r.json();

    // DRF puede devolver {results: []} o []
    allItems = Array.isArray(data) ? data : (data.results || []);
    applyFilter();
}

/* ============================================================
      FILTRO DE BÚSQUEDA
============================================================ */
function applyFilter(){
    const q = document.getElementById("q").value.trim().toLowerCase();
    const list = !q
        ? allItems
        : allItems.filter(x => (x.name || "").toLowerCase().includes(q));

    render(list);
}

document.getElementById("q").addEventListener("input", applyFilter);

/* ============================================================
      CREAR NUEVA CATEGORÍA  (POST)
============================================================ */
document.getElementById("frmNew").addEventListener("submit", async (e)=>{
    e.preventDefault();

    const name = document.getElementById("newName").value.trim();
    if(!name) return;

    const r = await apiFetch("/api/categories/", {
        method: "POST",
        headers:{
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ name })
    });

    if(!r || !r.ok){
        alert("No se pudo crear");
        return;
    }

    document.getElementById("newName").value = "";
    load();
});

/* ============================================================
      CLICK EN GUARDAR / ELIMINAR  (PATCH / DELETE)
============================================================ */
document.getElementById("rows").addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;

    const id = btn.dataset.id;

    /* -------------------------------
         GUARDAR CATEGORÍA (PATCH)
    -------------------------------- */
    if(btn.dataset.act === "save"){
        const input = document.querySelector(`input[data-id="${id}"]`);
        const name = input.value.trim();

        const r = await apiFetch(`/api/categories/${id}/`, {
            method: "PATCH",
            headers:{
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify({ name })
        });

        if(!r || !r.ok){
            alert("No se pudo guardar");
            return;
        }

        load();
    }

    /* -------------------------------
         ELIMINAR CATEGORÍA (DELETE)
    -------------------------------- */
    else if(btn.dataset.act === "del"){
        if(!confirm("¿Eliminar categoría?")) return;

        const r = await apiFetch(`/api/categories/${id}/`, {
            method: "DELETE",
            headers:{
                "X-CSRFToken": getCSRFToken()
            }
        });

        if(!r || (r.status !== 204 && !r.ok)){
            alert("No se pudo eliminar");
            return;
        }

        load();
    }
});

/* ============================================================
      INICIALIZAR
============================================================ */
load();
</script>

{% endblock %}

