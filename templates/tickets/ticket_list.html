{% extends "tickets/base.html" %}
{% block title %}Tickets · Coyahue{% endblock %}

{% block extra_head %}
<style>
  .glass{
    background:rgba(255,255,255,.92);
    backdrop-filter:blur(6px);
    border:1px solid rgba(15,23,42,.06);
    border-radius:1rem;
    padding:1.25rem 1.5rem;
    box-shadow:0 6px 20px rgba(0,0,0,.05);
  }

  th {
    cursor:pointer;
    white-space:nowrap;
  }

  .badge-pill{
    border-radius:999px;
    padding:.35rem .6rem;
    font-size:.75rem;
  }

  .table td {
    vertical-align: middle;
  }

  .scroll-area {
    max-height: 600px;
    overflow-y: auto;
  }
  .scroll-area::-webkit-scrollbar {
    width: 8px;
  }
  .scroll-area::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,.2);
    border-radius: 4px;
  }
  .scroll-area::-webkit-scrollbar-track {
    background: rgba(0,0,0,.05);
  }
</style>


{% endblock %}

{% block content %}

<!-- =========================================
     HEADER LISTADO DE TICKETS
========================================= -->
<div class="glass mb-3">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h1 class="h5 m-0 d-flex align-items-center gap-2">
      <i class="bi bi-ticket-perforated"></i> Tickets
    </h1>

    <a href="{% url 'ticket_new' %}" class="btn btn-primary btn-sm btn-ticket" data-hard-nav="1">
      <i class="bi bi-plus-lg"></i>
      <span>Nuevo</span>
    </a>
  </div>
</div>

<!-- =========================================
     FILTROS AVANZADOS (se muestran solo si compact_filters=False)
========================================= -->
{% if not compact_filters %}
<div class="glass mb-3">

  <form method="get"
        action="{% if mine %}{% url 'ticket_list' %}?mine=1{% else %}{% url 'ticket_list' %}{% endif %}"
        class="row g-2 align-items-end">

    {% if mine %}
      <input type="hidden" name="mine" value="1">
    {% endif %}

    <!-- Categoría -->
    <div class="col-md-2">
      <label class="form-label">Categoría</label>
      <select name="category" class="form-select form-select-sm">
        <option value="">Todas</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if category == c.id|stringformat:'s' %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Prioridad -->
    <div class="col-md-2">
      <label class="form-label">Prioridad</label>
      <select name="priority" class="form-select form-select-sm">
        <option value="">Todas</option>
        {% for p in priorities %}
          <option value="{{ p.code }}" {% if priority == p.code %}selected{% endif %}>
            {{ p.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Estado -->
    <div class="col-md-2">
      <label class="form-label">Estado</label>
      <select name="state" class="form-select form-select-sm">
        <option value="">Todos</option>
        <option value="open" {% if state == 'open' %}selected{% endif %}>Abiertos</option>
        <option value="in_progress" {% if state == 'in_progress' %}selected{% endif %}>En progreso</option>
        <option value="resolved" {% if state == 'resolved' %}selected{% endif %}>Resueltos</option>
        <option value="closed" {% if state == 'closed' %}selected{% endif %}>Cerrados</option>
      </select>
    </div>

    {% if not mine %}
    <!-- Asignado -->
    <div class="col-md-2">
      <label class="form-label">Asignado</label>
      <select name="assignee" class="form-select form-select-sm">
        <option value="">Todos</option>
        {% for u in assignees %}
          <option value="{{ u.id }}" {% if assignee == u.id|stringformat:'s' %}selected{% endif %}>
            {{ u.username }}
          </option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    <!-- Desde -->
    <div class="col-md-2">
      <label class="form-label">Desde</label>
      <input type="date" name="from" value="{{ from }}" class="form-control form-control-sm">
    </div>

    <!-- Hasta -->
    <div class="col-md-2">
      <label class="form-label">Hasta</label>
      <input type="date" name="to" value="{{ to }}" class="form-control form-control-sm">
    </div>

    <!-- Buscar -->
    <div class="col-md-3">
      <label class="form-label">Buscar</label>
      <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm"
             placeholder="Título o descripción">
    </div>

    <div class="col-md-2">
      <button class="btn btn-outline-secondary btn-sm w-100">Aplicar filtros</button>
    </div>

  </form>
</div>
{% endif %}

<!-- =========================================
     FILTROS REDUCIDOS (cuando compact_filters=True)
========================================= -->
{% if compact_filters %}
<div class="glass mb-3">

  <form method="get" class="row g-2 align-items-end">

    <!-- Buscar -->
    <div class="col-md-4">
      <label class="form-label">Buscar</label>
      <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm"
             placeholder="Título, descripción o #ID">
    </div>

    <!-- Desde -->
    <div class="col-md-3">
      <label class="form-label">Desde</label>
      <input type="date" name="from" value="{{ from }}" class="form-control form-control-sm">
    </div>

    <!-- Hasta -->
    <div class="col-md-3">
      <label class="form-label">Hasta</label>
      <input type="date" name="to" value="{{ to }}" class="form-control form-control-sm">
    </div>

    <div class="col-md-2">
      <button class="btn btn-outline-secondary btn-sm w-100">Filtrar</button>
    </div>

  </form>

</div>
{% endif %}

<!-- =========================================
     TABLA DE TICKETS
========================================= -->
<div class="glass">
  <div class="scroll-area table-responsive">

    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Título</th>
          <th>Categoría</th>
          <th>Prioridad</th>
          <th>Estado</th>
          <th>Asignado</th>
          <th>Creado</th>
          <th></th>
        </tr>
      </thead>

      <tbody>
        {% for t in tickets %}
        <tr>
          <td>#{{ t.id }}</td>
          <td>{{ t.title }}</td>
          <td>{{ t.category.name|default:"—" }}</td>
          <td>{{ t.priority.name|default:"—" }}</td>

          <td>
            {% if t.state == "open" %}
              <span class="badge badge-pill text-bg-danger">Abierto</span>
            {% elif t.state == "in_progress" %}
              <span class="badge badge-pill text-bg-warning">En progreso</span>
            {% elif t.state == "resolved" %}
              <span class="badge badge-pill text-bg-primary">Resuelto</span>
            {% elif t.state == "closed" %}
              <span class="badge badge-pill text-bg-success">Cerrado</span>
            {% else %}
              <span class="badge badge-pill text-bg-secondary">{{ t.state }}</span>
            {% endif %}
          </td>

          <td>{{ t.assigned_to.username|default:"—" }}</td>
          <td>{{ t.created_at|date:"Y-m-d H:i" }}</td>

          <td>
            <a href="{% url 'ticket_detail' t.id %}"
               class="btn btn-outline-primary btn-sm"
               data-hard-nav="1">
              Ver
            </a>
          </td>
        </tr>

        {% empty %}
        <tr>
          <td colspan="8" class="text-center text-muted py-4">
            No hay tickets que coincidan con los filtros.
          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>

  </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
  // Forzar navegación completa
  document.addEventListener("click", (e) => {
    const a = e.target.closest('a[data-hard-nav="1"]');
    if (!a) return;
    e.preventDefault();
    window.location.assign(a.getAttribute("href"));
  });
</script>
{% endblock %}