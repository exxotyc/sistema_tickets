{% extends "tickets/base.html" %}
{% block title %}Tickets · Coyahue{% endblock %}

{% block extra_head %}
<style>
  .glass{
    background:rgba(255,255,255,.92);
    backdrop-filter:blur(6px);
    border:1px solid rgba(15,23,42,.06);
    border-radius:1rem;
    padding:1.25rem 1.5rem;
    box-shadow:0 6px 20px rgba(0,0,0,.05);
  }

  th {
    cursor:pointer;
    white-space:nowrap;
  }

  .badge-pill{
    border-radius:999px;
    padding:.35rem .6rem;
    font-size:.75rem;
  }

  .table td {
    vertical-align: middle;
  }
</style>
{% endblock %}

{% block content %}

<div class="glass mb-3">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h1 class="h5 m-0 d-flex align-items-center gap-2">
      <i class="bi bi-ticket-perforated"></i> Tickets
    </h1>

    <a href="{% url 'ticket_new' %}" class="btn btn-primary btn-sm btn-ticket" data-hard-nav="1">
      <i class="bi bi-plus-lg"></i>
      <span>Nuevo</span>
    </a>
  </div>
</div>

<!-- ============================
     FILTROS AVANZADOS
============================= -->
<div class="glass mb-3">
  <form method="get" action="{% url 'ticket_list' %}" class="row g-2 align-items-end">

    <div class="col-md-2">
      <label class="form-label">Categoría</label>
      <select name="category" class="form-select form-select-sm">
        <option value="">Todas</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if category == c.id|stringformat:'s' %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Prioridad</label>
      <select name="priority" class="form-select form-select-sm">
        <option value="">Todas</option>
        {% for p in priorities %}
          <option value="{{ p.code }}" {% if priority == p.code %}selected{% endif %}>
            {{ p.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Estado</label>
      <select name="state" class="form-select form-select-sm">
        <option value="">Todos</option>
        <option value="open" {% if state == 'open' %}selected{% endif %}>Abiertos</option>
        <option value="in_progress" {% if state == 'in_progress' %}selected{% endif %}>En progreso</option>
        <option value="resolved" {% if state == 'resolved' %}selected{% endif %}>Resueltos</option>
        <option value="closed" {% if state == 'closed' %}selected{% endif %}>Cerrados</option>
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Asignado</label>
      <select name="assignee" class="form-select form-select-sm">
        <option value="">Todos</option>
        {% for t in assignees %}
        <option value="{{ t.id }}" {% if assignee == t.id|stringformat:'s' %}selected{% endif %}>
          {{ t.username }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Desde</label>
      <input type="date" name="from" value="{{ from }}" class="form-control form-control-sm">
    </div>

    <div class="col-md-2">
      <label class="form-label">Hasta</label>
      <input type="date" name="to" value="{{ to }}" class="form-control form-control-sm">
    </div>

    <div class="col-md-3">
      <label class="form-label">Buscar</label>
      <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm"
             placeholder="Título o descripción">
    </div>

    <div class="col-md-2">
      <button class="btn btn-outline-secondary btn-sm w-100">Aplicar filtros</button>
    </div>

  </form>
</div>

<!-- ============================
     TABLA DE TICKETS
============================= -->
<div class="glass">
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Título</th>
          <th>Categoría</th>
          <th>Prioridad</th>
          <th>Estado</th>
          <th>Asignado</th>
          <th>Creado</th>
          <th></th>
        </tr>
      </thead>
      <tbody>

        {% for t in tickets %}
        <tr>
          <td>#{{ t.id }}</td>
          <td>{{ t.title }}</td>
          <td>{{ t.category.name }}</td>
          <td>{{ t.priority.name }}</td>

          <td>
            {% if t.state == "open" %}
              <span class="badge badge-pill text-bg-danger">Abierto</span>
            {% elif t.state == "in_progress" %}
              <span class="badge badge-pill text-bg-warning">En progreso</span>
            {% elif t.state == "resolved" %}
              <span class="badge badge-pill text-bg-primary">Resuelto</span>
            {% elif t.state == "closed" %}
              <span class="badge badge-pill text-bg-success">Cerrado</span>
            {% else %}
              <span class="badge badge-pill text-bg-secondary">{{ t.state }}</span>
            {% endif %}
          </td>

          <td>{{ t.assigned_to.username|default:"—" }}</td>
          <td>{{ t.created_at|date:"Y-m-d H:i" }}</td>

          <td>
            <a href="{% url 'ticket_detail' t.id %}" data-hard-nav="1"
               class="btn btn-outline-primary btn-sm">
              Ver
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center text-muted py-4">
            No hay tickets que coincidan con los filtros.
          </td>
        </tr>
        {% endfor %}

      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Forzar navegación completa
  document.addEventListener("click", (e) => {
    const a = e.target.closest('a[data-hard-nav="1"]');
    if (!a) return;
    e.preventDefault();
    window.location.assign(a.getAttribute("href"));
  });
</script>
{% endblock %}
