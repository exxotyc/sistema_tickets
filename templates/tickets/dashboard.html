{% extends "tickets/base.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<style>
  .glass{background:rgba(255,255,255,.92); backdrop-filter:blur(6px); border:1px solid rgba(15,23,42,.06); border-radius:1rem}
  .kpi{border-radius:1rem; background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(255,255,255,.85)); border:1px solid rgba(15,23,42,.06); box-shadow:0 14px 30px rgba(2,6,23,.10)}
  .kpi .icon{width:44px; height:44px; display:grid; place-items:center; border-radius:12px; background:linear-gradient(135deg,#0ea5e922,#6366f122)}
  .kpi .num{font-size:1.8rem; line-height:1; font-weight:700}
  .chip{font-size:.75rem; padding:.25rem .5rem; border-radius:999px; border:1px solid rgba(15,23,42,.08); background:#fff}
  .progress-slim{height:10px; background:rgba(15,23,42,.08); border-radius:999px; overflow:hidden}
  .pb-danger{background:#ef4444}
  .pb-warn{background:#f59e0b}
  .pb-success{background:#22c55e}
  .card-soft{border-radius:1rem; border:1px solid rgba(15,23,42,.06); background:rgba(255,255,255,.9)}
  .table tr td,.table tr th{vertical-align:middle}
  .badge-soft{background:#fff; border:1px solid rgba(15,23,42,.08); color:#0f172a}
  .hover-up{transition:transform .2s ease, box-shadow .2s ease}
  .hover-up:hover{transform:translateY(-3px); box-shadow:0 18px 40px rgba(2,6,23,.12)}
</style>
{% endblock %}

{% block content %}
<div class="container py-3 py-md-4">

  <!-- Encabezado -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <span class="badge rounded-pill badge-soft">Coyahue</span>
      <h1 class="h4 m-0">Dashboard</h1>
    </div>
    <div class="btn-group">
      <a href="{% url 'ticket_list' %}" class="btn btn-primary btn-ripple">
        <i class="bi bi-list-ul me-1"></i>Listado
      </a>
      {% if not is_tecnico %}
  <a href="{% url 'ticket_new' %}" class="btn btn-primary btn-sm btn-ticket" data-hard-nav="1">
    <i class="bi bi-plus-lg"></i>
    <span>Nuevo</span>
  </a>
{% endif %}
    </div>
    
  </div>

  <!-- KPIs -->
  <div class="row g-3">
    <div class="col-6 col-md-3">
      <div class="kpi p-3 hover-up">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small">Total</div>
            <div class="num">{{ total }}</div>
          </div>
          <div class="icon"><i class="bi bi-grid"></i></div>
        </div>
        <div class="mt-2"><span class="chip">Todos</span></div>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <div class="kpi p-3 hover-up">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small">Abiertos</div>
            <div class="num">{{ abiertos }}</div>
          </div>
          <div class="icon"><i class="bi bi-bug"></i></div>
        </div>
        <div class="mt-2"><span class="chip">Pendientes</span></div>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <div class="kpi p-3 hover-up">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small">En progreso</div>
            <div class="num">{{ en_progreso }}</div>
          </div>
          <div class="icon"><i class="bi bi-hourglass-split"></i></div>
        </div>
        <div class="mt-2"><span class="chip">Atendiéndose</span></div>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <div class="kpi p-3 hover-up">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small">Resueltos</div>
            <div class="num">{{ resueltos }}</div>
          </div>
          <div class="icon"><i class="bi bi-check2-circle"></i></div>
        </div>
        <div class="mt-2"><span class="chip">Exitosos</span></div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi p-3 hover-up">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small">Mis tickets</div>
            <div class="num">{{ mios }}</div>
          </div>
          <div class="icon"><i class="bi bi-person-badge"></i></div>
        </div>
        <div class="mt-2"><span class="chip">Propios</span></div>
      </div>
    </div>
  </div>

  <!-- Distribución -->
  <div class="glass p-3 mt-3 hover-up">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="small text-muted">Distribución por estado</div>
      <div class="small">
        <span class="me-2"><i class="bi bi-square-fill" style="color:#ef4444"></i> Abiertos {{ pa }}%</span>
        <span class="me-2"><i class="bi bi-square-fill" style="color:#f59e0b"></i> Progreso {{ pp }}%</span>
        <span><i class="bi bi-square-fill" style="color:#22c55e"></i> Resueltos {{ pr }}%</span>
      </div>
    </div>
    <div class="progress-slim">
      <div class="pb-danger" style="width: {{ pa }}%; height:100%; float:left"></div>
      <div class="pb-warn" style="width: {{ pp }}%; height:100%; float:left"></div>
      <div class="pb-success" style="width: {{ pr }}%; height:100%; float:left"></div>
      <div style="clear:both"></div>
    </div>
  </div>

  <!-- Últimos tickets -->
  <div class="glass p-3 mt-3 hover-up">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <span class="small text-muted d-flex align-items-center gap-2">
        <i class="bi bi-clock-history"></i> Últimos tickets (7 días)
      </span>
      <a href="{% url 'ticket_list' %}" class="btn btn-sm btn-outline-secondary btn-ripple">Ver todos</a>
    </div>

    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Título</th>
            <th>Prioridad</th>
            <th>Estado</th>
            <th>SLA</th>
            <th>Creado</th>
          </tr>
        </thead>
        <tbody>
          {% for t in recientes %}
          <tr onclick="window.location.href='/tickets/{{ t.id }}/'" style="cursor:pointer">
            <td>{{ t.id }}</td>
            <td class="text-truncate" style="max-width:240px">{{ t.title }}</td>
            <td><span class="badge text-bg-light">{{ t.get_priority_display }}</span></td>
            <td>
              {% if t.state == "open" %}
                <span class="badge text-bg-danger">Abierto</span>
              {% elif t.state == "in_progress" %}
                <span class="badge text-bg-warning">En progreso</span>
              {% elif t.state == "resolved" %}
                <span class="badge text-bg-success">Resuelto</span>
              {% elif t.state == "closed" %}
                <span class="badge text-bg-secondary">Cerrado</span>
              {% else %}
                <span class="badge text-bg-light">{{ t.get_state_display }}</span>
              {% endif %}
            </td>
            <td>
              {% with label=t.get_sla_label %}
                <span class="badge text-bg-{{ label.1 }}">{{ label.2 }} {{ label.0 }}</span>
              {% endwith %}
            </td>
            <td class="text-nowrap">{{ t.created_at|date:"Y-m-d H:i" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="text-center text-muted py-3">No hay tickets recientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}
